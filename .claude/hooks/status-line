#!/bin/bash
#
# Claude Code Hooks - Status Line
#
# Forwards Status event to daemon via Unix socket and outputs plain text.
# This hook is called by Claude Code to populate the status line display.
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../init.sh"

# Ensure daemon is running (lazy startup)
if ! ensure_daemon; then
    # Fallback: output minimal status if daemon fails
    echo "Claude | Ctx: N/A"
    exit 0
fi

# Pipe JSON directly through socket
# Note: Status event returns context array that needs to be joined
jq -c '{event: "Status", hook_input: .}' | send_request_stdin | jq -r '
  if .result.context and (.result.context | length > 0) then
    .result.context | join(" ")
  else
    "Claude"
  end
'
