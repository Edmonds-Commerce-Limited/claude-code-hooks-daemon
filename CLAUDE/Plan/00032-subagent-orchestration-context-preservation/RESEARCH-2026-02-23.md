# Research: Agent Team Orchestration & Hook Agent Identification

**Date**: 2026-02-23
**Researcher**: Main Claude (Opus 4.6) with Explore + general-purpose sub-agents
**Purpose**: Determine if hooks can identify which agent fires them; research upstream solutions

---

## Key Finding: No Agent Identification in Tool-Use Hooks

**PreToolUse and PostToolUse events do NOT carry any agent identifier.** The `session_id` field is shared across the main thread and all its subagents, making it impossible to distinguish who is firing a hook.

### What CAN Be Identified (Per Event Type)

| Hook Event | Agent identification? | Fields available |
|---|---|---|
| `SubagentStart` | Yes | `agent_id`, `agent_type` |
| `SubagentStop` | Yes | `agent_id`, `agent_type`, `agent_transcript_path` |
| `TeammateIdle` | Yes | `teammate_name`, `team_name` |
| `TaskCompleted` | Yes | `teammate_name`, `team_name` |
| **PreToolUse** | **No** | Only `session_id` (shared across all agents) |
| **PostToolUse** | **No** | Only `session_id` (shared across all agents) |
| All other events | **No** | Only `session_id` |

### Implication for OrchestratorOnlyHandler (Plan 00019)

The existing `OrchestratorOnlyHandler` cannot distinguish main thread from teammate. If enabled, it blocks ALL agents equally. This makes it unsuitable for selective enforcement on just the orchestrator.

### Open GitHub Issues Requesting Agent Hierarchy in Hooks

1. **[GitHub Issue #7881](https://github.com/anthropics/claude-code/issues/7881)** - "SubagentStop cannot identify which subagent finished"
   - 19+ upvotes, still open
   - Proposed: Add `subagent_session` field propagated to all tool calls within a subagent

2. **[GitHub Issue #14859](https://github.com/anthropics/claude-code/issues/14859)** - "Agent Hierarchy in Hook Events, SubagentStart Hook"
   - 12+ upvotes, still open
   - Proposed: Add `agent_id`, `parent_agent_id`, `parent_session_id`, `agent_slug` to ALL hook events

**If either issue is resolved**, our `OrchestratorOnlyHandler` could be enhanced to check for an agent identifier and only enforce on the main thread.

---

## Delegate Mode: The Upstream Solution (Currently Broken)

### What Delegate Mode Is

Claude Code has a built-in **Delegate Mode** accessible via **Shift+Tab** cycling in the TUI. It restricts the lead agent to coordination-only tools:

- Task (spawn/manage agents)
- SendMessage (communicate with teammates)
- TaskCreate / TaskUpdate / TaskList / TaskGet (task management)

The lead **cannot** use Read, Write, Edit, Bash, Glob, Grep, or any implementation tools. This is exactly the orchestration enforcement we need.

### The Bug: Delegate Mode Cascades to Teammates

**Delegate mode currently cascades to spawned teammates**, stripping them of file system tools. This makes it completely unusable for agent teams.

Tracked in multiple GitHub issues:
- **[#23447](https://github.com/anthropics/claude-code/issues/23447)** - "Delegate mode cascades to teammates"
- **[#24073](https://github.com/anthropics/claude-code/issues/24073)** - "Teammates in Delegate Mode lose tool access"
- **[#24307](https://github.com/anthropics/claude-code/issues/24307)** - Related delegate mode issue
- **[#25037](https://github.com/anthropics/claude-code/issues/25037)** - "Delegate mode breaks agent teams"

Even passing `mode: "bypassPermissions"` in the Task tool call does NOT override the cascading restriction.

**No official fix as of February 2026.** Duplicate issues are still being filed, suggesting it remains unresolved.

### Why This Matters for Plan 00032

Delegate mode is the first-class upstream solution to our problem. When fixed, it will:
- Restrict the orchestrator to coordination-only tools (natively, no hooks needed)
- Allow teammates to have full tool access independently
- Eliminate the "orchestrator drift" problem at the platform level

---

## Plan Mode: A Partial Workaround

### How Plan Mode Works

Plan mode restricts Claude Code to read-only tools. Critically, the **Task tool IS allowed** in plan mode, so the orchestrator can spawn agents.

| Allowed in Plan Mode | Blocked in Plan Mode |
|---|---|
| Read, Glob, Grep | Edit, Write, NotebookEdit |
| **Task** (spawn agents) | **Bash** (all commands) |
| WebSearch, WebFetch | MCP write tools |
| TodoRead/TodoWrite | |
| AskUserQuestion | |

### The `permission_mode` Hook Field

The `permission_mode` field in hook_input shows `"plan"` when plan mode is active. Our hooks can detect this.

Available values: `"default"`, `"plan"`, `"acceptEdits"`, `"dontAsk"`, `"bypassPermissions"`

### Plan Mode Limitations as Orchestrator Workaround

1. **Blocks Bash entirely** - Orchestrator can't even run `git status` or `ls`
2. **Unknown if it cascades** - May have the same cascading bug as delegate mode
3. **Less restrictive than delegate** - Still allows Read/Glob/Grep (which consume context)
4. **No task management tools** - Plan mode doesn't explicitly allow TaskCreate/TaskUpdate etc.

### Plan Approval for Teammates

Claude Code supports requiring teammates to work in plan mode until the lead approves their approach via `plan_mode_required` parameter. This is a different use case (review gate, not orchestration enforcement).

---

## Other Mitigation Strategies (Natural Language)

Community best practices for preventing orchestrator drift without delegate mode:

1. **Explicit natural language instructions**: "You are a coordinator only. Never edit files. Always delegate via Task tool."
2. **Plan-first architecture**: Use plan mode for design, then hand off to team for execution
3. **File ownership boundaries**: Each teammate owns distinct files
4. **Small teams**: 2-4 teammates optimal, larger teams increase coordination overhead
5. **Require plan approval**: Force teammates into plan mode until lead approves
6. **Active monitoring**: Watch teammates and steer early when someone goes off-track

---

## Team-Specific Hook Events (For Future Use)

Two hook events are specifically designed for agent team quality control:

- **`TeammateIdle`**: Fires when a teammate is about to go idle. Exit code 2 sends feedback and keeps the teammate working.
- **`TaskCompleted`**: Fires when a task is being marked complete. Exit code 2 prevents completion and sends feedback.

These only support `type: "command"` hooks (not prompt or agent hooks). They don't have matchers.

---

## Complete Hook Input Field Reference

### Common Fields (All Events)

| Field | Type | Description |
|-------|------|-------------|
| `session_id` | string | Shared across main + all subagents |
| `transcript_path` | string | Conversation JSON log file |
| `cwd` | string | Current working directory |
| `permission_mode` | string | "default", "plan", "acceptEdits", "dontAsk", "bypassPermissions" |
| `hook_event_name` | string | Event type name |

### Environment Variables Available to Hooks

| Variable | Description |
|----------|-------------|
| `CLAUDE_PROJECT_DIR` | Project root path |
| `CLAUDE_SESSION_ID` | Current session ID (v2.1.9+) |
| `CLAUDE_CODE_REMOTE` | "true" in remote web environments |
| `CLAUDE_ENV_FILE` | (SessionStart only) File path for persisting env vars |
| `CLAUDE_PLUGIN_ROOT` | Plugin root directory |

### Event-Specific Fields

**SessionStart**: `source`, `model`, `agent_type` (optional)
**SessionEnd**: `reason`
**UserPromptSubmit**: `prompt`
**PreToolUse**: `tool_name`, `tool_input`, `tool_use_id`
**PostToolUse**: `tool_name`, `tool_input`, `tool_use_id`, `tool_response`
**SubagentStart**: `agent_id`, `agent_type`
**SubagentStop**: `stop_hook_active`, `agent_id`, `agent_type`, `agent_transcript_path`, `last_assistant_message`
**TeammateIdle**: `teammate_name`, `team_name`
**TaskCompleted**: `task_id`, `task_subject`, `task_description`, `teammate_name`, `team_name`
**Stop**: `stop_hook_active`, `last_assistant_message`
**PreCompact**: `trigger`, `custom_instructions`
**Notification**: `message`, `title`, `notification_type`
**PermissionRequest**: `tool_name`, `tool_input`, `permission_suggestions`

---

## Recommendation

**Hold Plan 00032 and wait for upstream delegate mode fix.**

### Rationale

1. **Delegate mode is exactly what we need** - It's a first-class platform feature that restricts the orchestrator while giving teammates full access
2. **The bug is well-known** - Multiple issues filed, active community pressure for a fix
3. **Hooks cannot solve this** - Without agent identification in PreToolUse events, our handlers can't distinguish orchestrator from teammate
4. **Workarounds are fragile** - Natural language nudges, plan mode, etc. all have significant limitations
5. **When fixed, minimal daemon work needed** - We may only need a SessionStart advisory handler to suggest delegate mode

### What We Should Monitor

- **[#23447](https://github.com/anthropics/claude-code/issues/23447)** - Primary delegate mode cascade bug
- **[#25037](https://github.com/anthropics/claude-code/issues/25037)** - Latest duplicate with active discussion
- **[#14859](https://github.com/anthropics/claude-code/issues/14859)** - Agent hierarchy in hook events (would enable our handler approach)
- **[#7881](https://github.com/anthropics/claude-code/issues/7881)** - Subagent identification in hooks

### What We Can Do Now

1. Keep the existing `OrchestratorOnlyHandler` (Plan 19) as-is - it works for single-agent scenarios
2. Update Plan 34 (model-aware advisor) to suggest delegate mode when it's fixed
3. Consider a lightweight SessionStart advisory: "For agent team orchestration, use delegate mode (Shift+Tab)"

---

## Sources

### Official Documentation
- [Claude Code Hooks Reference](https://code.claude.com/docs/en/hooks)
- [Claude Code Agent Teams](https://code.claude.com/docs/en/agent-teams)
- [Anthropic Hooks Docs](https://docs.anthropic.com/en/docs/claude-code/hooks)

### GitHub Issues
- [#7881: SubagentStop identification](https://github.com/anthropics/claude-code/issues/7881)
- [#14859: Agent hierarchy in hooks](https://github.com/anthropics/claude-code/issues/14859)
- [#23447: Delegate mode cascades](https://github.com/anthropics/claude-code/issues/23447)
- [#24073: Delegate mode tool loss](https://github.com/anthropics/claude-code/issues/24073)
- [#24307: Delegate mode related](https://github.com/anthropics/claude-code/issues/24307)
- [#25037: Delegate mode breaks teams](https://github.com/anthropics/claude-code/issues/25037)

### Community Resources
- [Addy Osmani: Claude Code Swarms](https://addyosmani.com/blog/claude-code-agent-teams/)
- [claudefa.st: Agent Teams Best Practices](https://claudefa.st/blog/guide/agents/agent-teams-best-practices)
- [claudefa.st: Agent Teams Controls](https://claudefa.st/blog/guide/agents/agent-teams-controls)
- [Armin Ronacher: What Is Plan Mode?](https://lucumr.pocoo.org/2025/12/17/what-is-plan-mode/)
- [alexop.dev: From Tasks to Swarms](https://alexop.dev/posts/from-tasks-to-swarms-agent-teams-in-claude-code/)
- [GitHub: Multi-Agent Observability Hooks](https://github.com/disler/claude-code-hooks-multi-agent-observability)
