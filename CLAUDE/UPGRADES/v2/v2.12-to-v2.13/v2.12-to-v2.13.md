# Upgrade Guide: v2.12 → v2.13

## ✅ NO BREAKING CHANGES - Safe Upgrade

**This is a backwards-compatible release.** You can upgrade without any configuration changes or manual intervention.

## Summary

Version 2.13.0 adds release process enforcement, single daemon process management for containers, and fixes critical PHP QA suppression gaps. Your existing configuration will continue to work without modifications.

**What's New**:
- **ReleaseBlockerHandler**: Project-specific handler prevents AI from skipping acceptance tests during releases
- **Single Daemon Enforcement**: Auto-enabled in containers to prevent daemon conflicts
- **PHP QA Fix**: 8 missing suppression patterns now blocked (security fix)
- **Realistic Acceptance Testing**: Streamlined from 127+ to 89 achievable tests
- **Plan Execution Guidance**: Clear model capability documentation

**Breaking Changes**: None
**Config Changes Required**: None
**Time Required**: 5 minutes

## Version Compatibility

- **Source Version**: v2.12.0
- **Target Version**: v2.13.0
- **Minimum Claude Code Version**: Any
- **Supports Rollback**: Yes
- **Breaking Changes**: No
- **Config Migration Required**: No

## Quick Upgrade (Standard Path)

```bash
# 1. Navigate to installation directory
cd .claude/hooks-daemon/

# 2. Pull latest changes
git fetch --tags
git checkout v2.13.0

# 3. Reinstall dependencies
untracked/venv/bin/pip install -e .

# 4. Restart daemon (if running)
untracked/venv/bin/python -m claude_code_hooks_daemon.daemon.cli restart
```

**That's it!** No configuration changes needed.

## What's New in v2.13.0

### 1. ReleaseBlockerHandler (Project Handler)

**Purpose**: Prevents AI agents from ending sessions during releases until acceptance tests are complete.

**How it works**:
- Detects when release files are modified (version.py, CHANGELOG.md, etc.)
- Blocks Stop events until release files are committed
- References RELEASING.md Step 8 for guidance
- Fails safely if git errors occur

**Configuration**: Auto-discovered as project handler (no config needed)

**Impact**: Only affects this project's release process (you won't see it in action unless releasing)

### 2. Single Daemon Process Enforcement

**Purpose**: Prevents multiple daemon instances from running simultaneously.

**Auto-enabled in containers** (YOLO mode, Docker, Podman):
- Installer detects container environment and enables automatically
- Kills other daemon processes on startup (SIGTERM → SIGKILL)
- Ensures clean daemon lifecycle

**Not in containers**:
- Only cleans up stale PID files for current project
- Safe for multi-user and multi-project environments

**Configuration** (optional manual override):
```yaml
daemon:
  enforce_single_daemon_process: true  # Auto-enabled in containers
```

**When to enable manually**:
- ✅ Single-user development machines
- ❌ Shared servers with multiple users/projects

**Impact**: Transparent - you won't notice unless you were experiencing daemon conflicts

### 3. PHP QA Suppression Fix (Critical Security)

**Problem**: PHP QA suppression handler was missing 8 patterns, allowing developers to bypass quality controls.

**Fix**: All modern PHPStan and PHPCS suppression patterns now blocked:
- `@phpstan-ignore` (modern identifier-specific)
- `phpcs:disable` / `phpcs:enable` (block-level)
- `phpcs:ignoreFile` (entire file)
- `@codingStandardsIgnoreStart/End/File` (deprecated but still used)

**Impact**: If you use PHP, quality control enforcement is now complete

### 4. Acceptance Testing Improvements

**Changes**:
- Categorized tests: EXECUTABLE (89 tests, 20-30 min), OBSERVABLE (10 tests, 30 sec), VERIFIED_BY_LOAD (30 tests, skip)
- Realistic time estimates in RELEASING.md
- Clear guidance on what to test vs skip
- Enhanced playbook generator with test type annotations

**Impact**: Clearer release testing process (only affects project maintainers)

### 5. Plan Execution Framework

**Added**: Strategy selection matrix and execution guidance for AI agents

**Impact**: Plans now specify recommended executor (Opus/Sonnet) and strategy (Sub-Agent Orchestration/Teams)

## Optional Configuration

### Enable Single Daemon Enforcement (if not in container)

If you want aggressive daemon cleanup on non-container machines:

```yaml
# .claude/hooks-daemon.yaml
daemon:
  enforce_single_daemon_process: true
```

**Recommendation**: Only enable on single-user development machines.

### Configure ReleaseBlockerHandler

ReleaseBlockerHandler is auto-discovered. If you want to disable it:

```yaml
# .claude/hooks-daemon.yaml
project_handlers:
  enabled: false  # Disables ALL project handlers
```

**Recommendation**: Leave enabled (it only activates during releases).

## Verification Steps

### 1. Verify Version Updated

```bash
cd .claude/hooks-daemon
cat src/claude_code_hooks_daemon/version.py
```

**Expected output**:
```python
__version__ = "2.13.0"
```

### 2. Verify Daemon Starts

```bash
cd .claude/hooks-daemon
untracked/venv/bin/python -m claude_code_hooks_daemon.daemon.cli restart
```

**Expected**: Daemon starts successfully without errors

### 3. Verify Handlers Load

```bash
cd .claude/hooks-daemon
untracked/venv/bin/python -m claude_code_hooks_daemon.daemon.cli status
```

**Expected**: Status: RUNNING

### 4. Check Daemon Logs (optional)

```bash
cat .claude/hooks-daemon/untracked/daemon.log
```

**Expected**: No errors related to handler loading or configuration

## Rollback Instructions

If you need to revert to v2.12.0:

```bash
# 1. Stop daemon (if running)
cd .claude/hooks-daemon
untracked/venv/bin/python -m claude_code_hooks_daemon.daemon.cli stop

# 2. Checkout previous version
git checkout v2.12.0

# 3. Reinstall dependencies
untracked/venv/bin/pip install -e .

# 4. Restart daemon
untracked/venv/bin/python -m claude_code_hooks_daemon.daemon.cli restart

# 5. Verify rollback
cat src/claude_code_hooks_daemon/version.py
# Should show: __version__ = "2.12.0"
```

**Note**: No configuration restoration needed (config is unchanged).

## Testing Statistics

- **Total Tests**: 5,663 passing, 0 failed, 3 skipped
- **Coverage**: 95.0% (strict requirement maintained)
- **New Tests**: 74 tests added for new features
- **QA Checks**: 7/7 passing (Magic Values, Format, Lint, Types, Tests, Security, Dependencies)

## Configuration Examples

### Before v2.13 (Still Valid)

```yaml
version: 1.0
daemon:
  idle_timeout_seconds: 600
  log_level: INFO
handlers:
  pre_tool_use:
    destructive_git:
      enabled: true
      priority: 10
  post_tool_use:
    lint_on_edit:
      enabled: true
      priority: 25
project_handlers:
  enabled: true
  path: .claude/project-handlers
```

### After v2.13 (No Changes Required)

**Same config works!** Optional additions:

```yaml
version: 1.0
daemon:
  idle_timeout_seconds: 600
  log_level: INFO
  enforce_single_daemon_process: true  # Optional: Enable on single-user machines
handlers:
  pre_tool_use:
    destructive_git:
      enabled: true
      priority: 10
  post_tool_use:
    lint_on_edit:
      enabled: true
      priority: 25
project_handlers:
  enabled: true  # ReleaseBlockerHandler auto-discovered
  path: .claude/project-handlers
```

## Known Issues

None. This is a stable, backwards-compatible release.

## Support

If you encounter issues:

1. **Check daemon logs**:
   ```bash
   cat .claude/hooks-daemon/untracked/daemon.log
   ```

2. **Verify daemon status**:
   ```bash
   cd .claude/hooks-daemon
   untracked/venv/bin/python -m claude_code_hooks_daemon.daemon.cli status
   ```

3. **Check configuration syntax**:
   ```bash
   cd .claude/hooks-daemon
   untracked/venv/bin/python -c "import yaml; yaml.safe_load(open('../../.claude/hooks-daemon.yaml'))"
   ```

4. **Report issue**:
   - GitHub: https://github.com/Edmonds-Commerce-Limited/claude-code-hooks-daemon/issues
   - Include: version info, config file, daemon logs

## References

- **Full Release Notes**: [RELEASES/v2.13.0.md](/workspace/RELEASES/v2.13.0.md)
- **Upgrade System Documentation**: [CLAUDE/UPGRADES/v2/README.md](/workspace/CLAUDE/UPGRADES/v2/README.md)
- **Changelog**: [CHANGELOG.md](/workspace/CHANGELOG.md) (v2.13.0 entry)
- **GitHub Release**: https://github.com/Edmonds-Commerce-Limited/claude-code-hooks-daemon/releases/tag/v2.13.0
- **Full Changelog**: https://github.com/Edmonds-Commerce-Limited/claude-code-hooks-daemon/compare/v2.12.0...v2.13.0

## Summary

**Key Takeaway**: This is a safe, backwards-compatible upgrade. Just pull the code, reinstall dependencies, and restart the daemon. No configuration changes needed.

**Time Investment**: 5 minutes for upgrade + verification

**Risk**: Low - fully backwards-compatible, extensive testing (5,663 tests passing)

**Recommendation**: Upgrade at your convenience. No urgency unless you need the PHP QA fix or single daemon enforcement.

---

**Questions?** See [full release notes](/workspace/RELEASES/v2.13.0.md) or open a GitHub issue.
