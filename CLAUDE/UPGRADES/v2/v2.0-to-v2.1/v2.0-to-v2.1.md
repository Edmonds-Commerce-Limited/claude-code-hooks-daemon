# Upgrade Guide: v2.0 ‚Üí v2.1

## Summary

This upgrade adds the **YOLO Container Detection Handler** for SessionStart events. The handler automatically detects YOLO container environments (Claude Code CLI running in isolated containers) and provides contextual information to Claude about the runtime environment. This is a feature addition with no breaking changes - recommended for all users running Claude Code in container environments.

**What's New**:
- Automatic YOLO container environment detection
- Multi-tier confidence scoring system (prevents false positives)
- Configurable detection thresholds and output verbosity
- Informational context provided at session start
- No performance impact (non-blocking, advisory handler)

## Version Compatibility

- **Source Version**: v2.0.0 (minimum)
- **Target Version**: v2.1.0
- **Minimum Claude Code Version**: Any
- **Supports Rollback**: Yes
- **Breaking Changes**: No
- **Config Migration Required**: No (optional config additions)

## Pre-Upgrade Checklist

Before starting the upgrade:

- [ ] Backup `.claude/hooks-daemon.yaml`
  ```bash
  cp .claude/hooks-daemon.yaml .claude/hooks-daemon.yaml.backup
  ```
- [ ] Check current version
  ```bash
  cd .claude/hooks-daemon
  cat src/claude_code_hooks_daemon/version.py  # Should show 2.0.0
  ```
- [ ] Verify daemon status
  ```bash
  untracked/venv/bin/python -m claude_code_hooks_daemon.daemon.cli status
  ```

## Changes Overview

### New Features

- **YOLO Container Detection**: Automatic detection of container environments
- **Confidence Scoring System**: Multi-tier scoring prevents false positives
- **Configurable Output**: Control detail level and informational tips
- **Environment Analysis**: Detects 9 different container indicators

### New Handlers

- **`yolo_container_detection`** (event: SessionStart, priority: 40, terminal: No)
  - **Description**: Detects YOLO container environments using confidence scoring
  - **Config Options**:
    - `enabled`: Enable/disable handler (default: true)
    - `min_confidence_score`: Detection threshold 0-12 (default: 3)
    - `show_detailed_indicators`: Show detected indicators (default: true)
    - `show_workflow_tips`: Show container workflow implications (default: true)
  - **Use Case**: Provides automatic context about container runtime to Claude

### Configuration Changes

#### New Config Section

Added `yolo_container_detection` handler under `handlers.session_start`:

```yaml
handlers:
  session_start:
    yolo_container_detection:
      enabled: true
      priority: 40
      min_confidence_score: 3
      show_detailed_indicators: true
      show_workflow_tips: true
```

#### No Breaking Changes

- All existing configurations remain valid
- New handler is optional (can be disabled)
- Default behavior unchanged for non-container environments

### Code Changes

- Added `src/claude_code_hooks_daemon/handlers/session_start/yolo_container_detection.py`
- Updated `src/claude_code_hooks_daemon/hooks/session_start.py` (handler registration)
- Added `src/claude_code_hooks_daemon/version.py` (version tracking)
- Added comprehensive test suite (44 tests, 89% coverage)
- Updated `install.py` (default config template)
- Updated `CLAUDE/HANDLER_DEVELOPMENT.md` (example documentation)

## Step-by-Step Upgrade Instructions

### 1. Update Daemon Code

```bash
cd .claude/hooks-daemon
git fetch origin
git checkout v2.1.0
# Or for latest: git pull origin main
```

### 2. Update Dependencies

```bash
cd .claude/hooks-daemon
untracked/venv/bin/pip install -e .
```

**Expected output**:
```
Successfully installed claude-code-hooks-daemon-2.1.0
```

### 3. Update Configuration File (Optional)

**File**: `.claude/hooks-daemon.yaml`

**Action**: Add YOLO handler configuration (handler works with defaults even without explicit config)

**Supporting Files in This Directory**:
- `config-before.yaml` - Example v2.0 config (before upgrade)
- `config-after.yaml` - Example v2.1 config (after upgrade)
- `config-additions.yaml` - Just the new YOLO config to add

**Option 1 - Add New Handler** (recommended):

Add this to the `handlers.session_start` section in `.claude/hooks-daemon.yaml`:

```yaml
handlers:
  session_start:
    yolo_container_detection:     # NEW in v2.1
      enabled: true                # Set to false to disable detection
      priority: 40                 # Workflow range priority
      min_confidence_score: 3      # Threshold for detection (0-12 range)
      show_detailed_indicators: true   # Show detected indicators
      show_workflow_tips: true     # Show container workflow tips
```

**Option 2 - Use Defaults** (no config change needed):

The handler is enabled by default. If you don't add explicit config, it will use:
- `enabled: true`
- `min_confidence_score: 3`
- `show_detailed_indicators: true`
- `show_workflow_tips: true`

**Why This Change**:
Provides automatic detection and context about YOLO container environments, helping Claude understand the runtime constraints (ephemeral storage, root access, etc.)

### 4. Hook Scripts

**No action needed** - SessionStart hook scripts are unchanged.

### 5. Restart Daemon (if running)

```bash
cd .claude/hooks-daemon
untracked/venv/bin/python -m claude_code_hooks_daemon.daemon.cli restart
```

**Expected output**:
```
Daemon stopped successfully
Daemon started with PID: XXXXX
```

**Note**: With lazy startup, daemon may not be running. That's normal.

## Breaking Changes

**No breaking changes in this release.**

All existing functionality remains unchanged. The new handler is additive only.

## Verification Steps

### 1. Verify Version Updated

```bash
cd .claude/hooks-daemon
cat src/claude_code_hooks_daemon/version.py
```

**Expected output**:
```python
__version__ = "2.1.0"
```

### 2. Verify Daemon Starts

```bash
cd .claude/hooks-daemon
untracked/venv/bin/python -m claude_code_hooks_daemon.daemon.cli status
```

**Expected**: Either "Daemon is running" or "Daemon is not running" (both are fine - lazy startup)

### 3. Test SessionStart Hook

```bash
cd /path/to/project
echo '{"hook_event_name":"SessionStart","source":"new"}' | \
  .claude/hooks/session-start
```

**Expected output** (in YOLO container):
```json
{
  "decision": "allow",
  "reason": null,
  "context": [
    "üê≥ Running in YOLO container environment (Claude Code CLI in sandbox)",
    "Detected indicators:",
    "  ‚Ä¢ CLAUDECODE=1 environment variable",
    "  ‚Ä¢ Running as root user (UID 0)",
    "",
    "Container workflow implications:",
    "  ‚Ä¢ Full development environment available",
    "  ‚Ä¢ Storage is ephemeral - commit and push to persist",
    "  ‚Ä¢ Running as root - install packages freely",
    "  ‚Ä¢ Fast iteration enabled (YOLO mode)"
  ]
}
```

**Expected output** (non-container):
```json
{
  "decision": "allow",
  "reason": null,
  "context": []
}
```

### 4. Test New Handler in Live Session

Start a new Claude Code session. If running in a YOLO container, you should see detection messages at session start.

### 5. Run Tests (for developers)

```bash
cd .claude/hooks-daemon
.venv/bin/pytest tests/unit/handlers/session_start/test_yolo_container_detection.py -v
```

**Expected**: 44 tests pass, 89% coverage on handler

### 6. Run Automated Verification

```bash
cd .claude/hooks-daemon
bash CLAUDE/UPGRADES/v2/v2.0-to-v2.1/verification.sh
```

**Expected output**:
```
‚úÖ Version check: PASS
‚úÖ Config validation: PASS
‚úÖ SessionStart hook: PASS
‚úÖ YOLO handler: PASS

=== All Verification Checks Passed ===
```

## Rollback Instructions

If you need to revert to v2.0.0:

### 1. Stop Daemon

```bash
cd .claude/hooks-daemon
untracked/venv/bin/python -m claude_code_hooks_daemon.daemon.cli stop
```

### 2. Restore Configuration (if modified)

```bash
cp .claude/hooks-daemon.yaml.backup .claude/hooks-daemon.yaml
```

### 3. Revert Code

```bash
cd .claude/hooks-daemon
git checkout v2.0.0
```

### 4. Reinstall Dependencies

```bash
untracked/venv/bin/pip install -e .
```

### 5. Verify Rollback

```bash
cat src/claude_code_hooks_daemon/version.py
# Should show: __version__ = "2.0.0"
```

## Known Issues

**No known issues at this time.**

The handler has comprehensive error handling and fails open (never blocks session start).

## Configuration Examples

### Disable YOLO Detection

```yaml
handlers:
  session_start:
    yolo_container_detection:
      enabled: false  # Disable detection
```

### Reduce Output Verbosity

```yaml
handlers:
  session_start:
    yolo_container_detection:
      enabled: true
      show_detailed_indicators: false  # Hide indicator list
      show_workflow_tips: false        # Hide workflow tips
```

### Increase Detection Threshold

```yaml
handlers:
  session_start:
    yolo_container_detection:
      enabled: true
      min_confidence_score: 6  # Require stronger signals (default: 3)
```

## Additional Notes

### Performance

- Handler is non-terminal and non-blocking
- Sub-millisecond execution time
- No impact on session startup performance

### Compatibility

- Works with all container runtimes (Podman, Docker, etc.)
- Compatible with non-container environments (no false positives)
- Safe for CI/CD pipelines

### Future Enhancements

Planned for future versions:
- Detection of resource limits (CPU, memory)
- Container-specific workflow recommendations
- Integration with container health checks

## Support

If you encounter issues:

1. **Check detection working**:
   ```bash
   # See what indicators are detected
   cd .claude/hooks-daemon
   untracked/venv/bin/python -c "
   from handlers.session_start.yolo_container_detection import YoloContainerDetectionHandler
   h = YoloContainerDetectionHandler()
   print(f'Score: {h._calculate_confidence_score()}')
   print(f'Indicators: {h._get_detected_indicators()}')
   "
   ```

2. **Check daemon logs**:
   ```bash
   cat .claude/hooks-daemon/untracked/venv/daemon.log
   ```

3. **Report issue**:
   - GitHub: https://github.com/Edmonds-Commerce-Limited/claude-code-hooks-daemon/issues
   - Include: version info, environment details, detection score output

## References

- [Upgrade system documentation](../../README.md)
- [Handler development guide](../../../HANDLER_DEVELOPMENT.md)
- [YOLO handler source](../../../src/claude_code_hooks_daemon/handlers/session_start/yolo_container_detection.py)
- [Test suite](../../../tests/unit/handlers/session_start/test_yolo_container_detection.py)
