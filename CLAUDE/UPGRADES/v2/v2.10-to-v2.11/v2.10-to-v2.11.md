# Upgrade Guide: v2.10 → v2.11

## Summary

This upgrade removes two project-specific handlers that were "hangover code" from early development. These handlers were specific to one project's workflow and should not have been in the core daemon. If you relied on similar functionality, you can recreate it using project-level handlers.

**Breaking Changes**:
- Removed `validate_sitemap` handler (PostToolUse event)
- Removed `remind_validator` handler (SubagentStop event)

**Impact**: Low - These handlers were project-specific and unlikely to be used by other projects. If your config references them, they will be safely ignored (daemon continues to work).

## Version Compatibility

- **Source Version**: v2.10.0 or v2.10.1
- **Target Version**: v2.11.0
- **Minimum Claude Code Version**: Any
- **Supports Rollback**: Yes
- **Breaking Changes**: Yes (handler removal)
- **Config Migration Required**: Recommended (remove obsolete handler references)

## Pre-Upgrade Checklist

Before starting the upgrade:

- [ ] Backup `.claude/hooks-daemon.yaml`
  ```bash
  cp .claude/hooks-daemon.yaml .claude/hooks-daemon.yaml.backup
  ```
- [ ] Check if you use either removed handler
  ```bash
  grep -E "validate_sitemap|remind_validator" .claude/hooks-daemon.yaml
  ```
- [ ] Check current version
  ```bash
  cd .claude/hooks-daemon
  cat src/claude_code_hooks_daemon/version.py  # Should show 2.10.x
  ```
- [ ] Verify daemon status
  ```bash
  untracked/venv/bin/python -m claude_code_hooks_daemon.daemon.cli status
  ```

## Changes Overview

### Removed Handlers

#### 1. validate_sitemap (PostToolUse)

**What it did**: After editing markdown files in `CLAUDE/Sitemap/`, reminded to validate the sitemap files.

**Why removed**: This was project-specific validation for one project's sitemap organization system. Not applicable to other projects.

**Migration path**: If you need similar functionality, recreate it as a project-level handler (see Migration Instructions below).

**Config location**: `handlers.post_tool_use.validate_sitemap`

#### 2. remind_validator (SubagentStop)

**What it did**: After builder agents completed (sitemap-modifier, page-implementer, etc.), reminded to run corresponding validator agents.

**Why removed**: This was project-specific workflow for one project's builder/validator agent pattern. Not applicable to other projects.

**Migration path**: If you need similar functionality, recreate it as a project-level handler (see Migration Instructions below).

**Config location**: `handlers.subagent_stop.remind_validator`

### Configuration Changes

**Before v2.11** (if these handlers were configured):
```yaml
handlers:
  post_tool_use:
    validate_sitemap:
      enabled: true
      priority: 50

  subagent_stop:
    remind_validator:
      enabled: true
      priority: 50
```

**After v2.11** (remove these entries):
```yaml
handlers:
  post_tool_use:
    # validate_sitemap removed - use project handlers if needed

  subagent_stop:
    # remind_validator removed - use project handlers if needed
```

### Code Changes

- Removed `src/claude_code_hooks_daemon/handlers/post_tool_use/validate_sitemap.py`
- Removed `src/claude_code_hooks_daemon/handlers/subagent_stop/remind_validator.py`
- Removed handler constants from `src/claude_code_hooks_daemon/constants/handlers.py`
- Removed handler priorities from `src/claude_code_hooks_daemon/constants/priority.py`
- Updated hook entry points to remove handler registration
- Removed all tests for both handlers
- Updated install template to not include these handlers

## Step-by-Step Upgrade Instructions

### 1. Update Daemon Code

```bash
cd .claude/hooks-daemon
git fetch origin
git checkout v2.11.0
# Or for latest: git pull origin main
```

### 2. Update Dependencies

```bash
cd .claude/hooks-daemon
untracked/venv/bin/pip install -e .
```

**Expected output**:
```
Successfully installed claude-code-hooks-daemon-2.11.0
```

### 3. Update Configuration File

**File**: `.claude/hooks-daemon.yaml`

**Action**: Remove obsolete handler references (if present)

**Supporting Files in This Directory**:
- `config-before.yaml` - Example v2.10 config with removed handlers
- `config-after.yaml` - Example v2.11 config without removed handlers
- `migration-script.sh` - Automated migration script

**Option 1 - Automatic Migration** (recommended):

```bash
cd .claude/hooks-daemon
bash CLAUDE/UPGRADES/v2/v2.10-to-v2.11/migration-script.sh
```

This script will:
- Detect if removed handlers are in your config
- Comment them out with explanatory notes
- Suggest migration to project handlers if needed

**Option 2 - Manual Migration**:

1. Open `.claude/hooks-daemon.yaml`
2. Search for `validate_sitemap` and `remind_validator`
3. Remove or comment out these handler entries

**Example manual edit**:
```yaml
handlers:
  post_tool_use:
    # validate_sitemap:  # REMOVED in v2.11 - project-specific handler
    #   enabled: true    # Migrate to project handlers if needed
    #   priority: 50

  subagent_stop:
    # remind_validator:  # REMOVED in v2.11 - project-specific handler
    #   enabled: true    # Migrate to project handlers if needed
    #   priority: 50
```

**Why This Change**:
These handlers were project-specific "hangover code" from early development. They don't belong in the core daemon because they implement workflow patterns specific to one project. The proper place for project-specific handlers is `.claude/project-handlers/`.

### 4. Hook Scripts

**No action needed** - Hook scripts are unchanged, handlers are just removed from the registry.

### 5. Restart Daemon (if running)

```bash
cd .claude/hooks-daemon
untracked/venv/bin/python -m claude_code_hooks_daemon.daemon.cli restart
```

**Expected output**:
```
Daemon stopped successfully
Daemon started with PID: XXXXX
```

**Note**: With lazy startup, daemon may not be running. That's normal.

## Breaking Changes

### Handler Removal

**validate_sitemap** and **remind_validator** handlers are completely removed.

**Impact**:
- If your config references these handlers, they will be silently ignored (no error)
- If you relied on this functionality, you must migrate to project handlers
- Daemon continues to work normally - this is a clean removal

**Who is affected**:
- Projects that explicitly enabled these handlers in config
- Projects that relied on sitemap validation reminders
- Projects that used builder/validator agent workflow patterns

**Not affected**:
- Projects that never configured these handlers
- Projects using standard built-in handlers only

## Migration to Project Handlers

If you need functionality similar to the removed handlers, recreate them as project-level handlers.

### Migrating validate_sitemap

**Original behavior**: Reminded to validate sitemap files after editing markdown in `CLAUDE/Sitemap/`.

**Project handler recreation**:

1. **Initialize project handlers directory** (if not already done):
   ```bash
   cd /path/to/your/project
   untracked/venv/bin/python -m claude_code_hooks_daemon.daemon.cli init-project-handlers
   ```

2. **Create handler file**: `.claude/project-handlers/post_tool_use/sitemap_validation_reminder.py`

```python
"""Sitemap validation reminder handler - project-specific."""

from typing import Any

from claude_code_hooks_daemon.core import Handler, HookResult
from claude_code_hooks_daemon.core.hook_result import Decision
from claude_code_hooks_daemon.core.utils import get_file_path


class SitemapValidationReminderHandler(Handler):
    """Remind to validate sitemap files after editing."""

    def __init__(self) -> None:
        super().__init__(
            handler_id="sitemap-validation-reminder",
            priority=50,
            terminal=False,
            tags=["project", "validation", "sitemap"],
        )

    def matches(self, hook_input: dict[str, Any]) -> bool:
        """Match Write/Edit operations on sitemap markdown files."""
        tool_name = hook_input.get("tool_name")
        if tool_name not in ["Write", "Edit"]:
            return False

        file_path = get_file_path(hook_input)
        if not file_path:
            return False

        # Match your project's sitemap directory
        if "CLAUDE/Sitemap/" not in file_path:
            return False

        # Ignore documentation file
        if file_path.endswith("CLAUDE/Sitemap/CLAUDE.md"):
            return False

        return file_path.endswith(".md")

    def handle(self, hook_input: dict[str, Any]) -> HookResult:
        """Provide validation reminder."""
        file_path = get_file_path(hook_input) or "sitemap file"
        return HookResult(
            decision=Decision.ALLOW,
            context=[
                f"Edited sitemap file: {file_path}",
                "",
                "REMINDER: Validate sitemap structure",
                "  - Check links are valid",
                "  - Verify hierarchy is correct",
                "  - Run sitemap validator if available",
            ],
        )
```

3. **Test the handler**:
   ```bash
   # Restart daemon to load new handler
   untracked/venv/bin/python -m claude_code_hooks_daemon.daemon.cli restart

   # Test by editing a sitemap file
   # You should see the reminder in Claude Code
   ```

### Migrating remind_validator

**Original behavior**: After builder agents completed, reminded to run corresponding validator agents.

**Project handler recreation**:

1. **Initialize project handlers directory** (if not already done)

2. **Create handler file**: `.claude/project-handlers/subagent_stop/validator_reminder.py`

```python
"""Validator reminder handler - project-specific."""

from typing import Any, ClassVar

from claude_code_hooks_daemon.core import Handler, HookResult
from claude_code_hooks_daemon.core.hook_result import Decision


class ValidatorReminderHandler(Handler):
    """Remind to run validator agents after builder agents complete."""

    # Map your project's builder agents to validator agents
    BUILDER_TO_VALIDATOR: ClassVar[dict[str, dict[str, str]]] = {
        "your-builder-agent": {
            "validator": "your-validator-agent",
            "description": "what was built",
            "validation_command": "Task tool: subagent_type: your-validator-agent",
        },
        # Add more mappings as needed
    }

    def __init__(self) -> None:
        super().__init__(
            handler_id="validator-reminder",
            priority=50,
            terminal=False,
            tags=["project", "workflow", "validation"],
        )

    def matches(self, hook_input: dict[str, Any]) -> bool:
        """Match builder agent completion."""
        subagent_type = hook_input.get("subagent_type", "")
        return subagent_type in self.BUILDER_TO_VALIDATOR

    def handle(self, hook_input: dict[str, Any]) -> HookResult:
        """Provide validator reminder."""
        subagent_type = hook_input.get("subagent_type", "")
        mapping = self.BUILDER_TO_VALIDATOR.get(subagent_type, {})

        return HookResult(
            decision=Decision.ALLOW,
            context=[
                f"Builder agent '{subagent_type}' completed",
                "",
                f"REMINDER: Run validator agent '{mapping.get('validator')}'",
                f"  Validates: {mapping.get('description')}",
                "",
                "Command:",
                mapping.get("validation_command", ""),
            ],
        )
```

3. **Customize for your workflow**:
   - Update `BUILDER_TO_VALIDATOR` mapping with your agent names
   - Adjust validation commands for your project

4. **Test the handler** by running a builder agent and checking for the reminder

### Project Handlers Documentation

For complete documentation on creating project handlers:
- Read `.claude/hooks-daemon/CLAUDE/PROJECT_HANDLERS.md`
- See examples in `.claude/hooks-daemon/examples/project-handlers/`
- Run `untracked/venv/bin/python -m claude_code_hooks_daemon.daemon.cli validate-project-handlers` to test

## Verification Steps

### 1. Verify Version Updated

```bash
cd .claude/hooks-daemon
cat src/claude_code_hooks_daemon/version.py
```

**Expected output**:
```python
__version__ = "2.11.0"
```

### 2. Verify Daemon Starts

```bash
cd .claude/hooks-daemon
untracked/venv/bin/python -m claude_code_hooks_daemon.daemon.cli status
```

**Expected**: Either "Daemon is running" or "Daemon is not running" (both are fine - lazy startup)

### 3. Verify No Handler Errors

```bash
cd .claude/hooks-daemon
untracked/venv/bin/python -m claude_code_hooks_daemon.daemon.cli restart
```

Check daemon logs for errors:
```bash
tail -20 .claude/hooks-daemon/untracked/daemon.log
```

**Expected**: No errors about missing handlers or failed imports

### 4. Test Hook Events

**PostToolUse test** (verify validate_sitemap is gone):
```bash
cd /path/to/project
# Edit any file - should not see sitemap validation message
# (unless you migrated to project handler)
```

**SubagentStop test** (verify remind_validator is gone):
```bash
# Run any subagent - should not see validator reminder
# (unless you migrated to project handler)
```

### 5. Run Automated Verification

```bash
cd .claude/hooks-daemon
bash CLAUDE/UPGRADES/v2/v2.10-to-v2.11/verification.sh
```

**Expected output**:
```
✅ Version check: PASS (v2.11.0)
✅ Config validation: PASS (no obsolete handlers)
✅ Daemon restart: PASS
✅ No handler errors: PASS

=== All Verification Checks Passed ===
```

## Rollback Instructions

If you need to revert to v2.10.1:

### 1. Stop Daemon

```bash
cd .claude/hooks-daemon
untracked/venv/bin/python -m claude_code_hooks_daemon.daemon.cli stop
```

### 2. Restore Configuration (if modified)

```bash
cp .claude/hooks-daemon.yaml.backup .claude/hooks-daemon.yaml
```

### 3. Revert Code

```bash
cd .claude/hooks-daemon
git checkout v2.10.1
```

### 4. Reinstall Dependencies

```bash
untracked/venv/bin/pip install -e .
```

### 5. Verify Rollback

```bash
cat src/claude_code_hooks_daemon/version.py
# Should show: __version__ = "2.10.1"
```

### 6. Restart Daemon

```bash
untracked/venv/bin/python -m claude_code_hooks_daemon.daemon.cli restart
```

## Known Issues

**No known issues at this time.**

This is a clean removal of unused handlers. The daemon continues to function normally.

## Configuration Examples

### Minimal Config (No Removed Handlers)

If you never used the removed handlers, your config is already compatible. No changes needed.

### Config with Removed Handlers (Migration Required)

**Before v2.11**:
```yaml
handlers:
  post_tool_use:
    bash_error_detector:
      enabled: true
      priority: 10

    validate_sitemap:  # This will be ignored in v2.11
      enabled: true
      priority: 50

  subagent_stop:
    subagent_completion_logger:
      enabled: true
      priority: 10

    remind_validator:  # This will be ignored in v2.11
      enabled: true
      priority: 50
```

**After v2.11** (cleaned up):
```yaml
handlers:
  post_tool_use:
    bash_error_detector:
      enabled: true
      priority: 10

    # validate_sitemap removed - migrated to project handlers

  subagent_stop:
    subagent_completion_logger:
      enabled: true
      priority: 10

    # remind_validator removed - migrated to project handlers
```

## Additional Notes

### Why Were These Handlers Removed?

These handlers were "hangover code" from early development when the project structure wasn't fully designed. They implemented workflow patterns specific to one project:

- **validate_sitemap**: Specific to a project with `CLAUDE/Sitemap/` structure
- **remind_validator**: Specific to a project with builder/validator agent pairs

**Why this matters**: The core daemon should contain only cross-project, general-purpose handlers. Project-specific workflow handlers belong in `.claude/project-handlers/` where they can be version-controlled with the project that needs them.

### Performance

- No performance impact - handlers are simply removed from registry
- Daemon startup time unchanged
- No new dependencies or features

### Compatibility

- Works with all Claude Code versions
- Compatible with all existing handlers
- Project handlers system unchanged

### Future Enhancements

No specific enhancements planned related to this change. The project handlers system provides the extensibility needed for custom workflow handlers.

## Support

If you encounter issues:

1. **Check config is valid**:
   ```bash
   cd .claude/hooks-daemon
   untracked/venv/bin/python -m claude_code_hooks_daemon.daemon.cli validate-config
   ```

2. **Check daemon logs**:
   ```bash
   cat .claude/hooks-daemon/untracked/daemon.log
   ```

3. **Verify no obsolete references**:
   ```bash
   grep -rn "validate_sitemap\|remind_validator" .claude/
   ```

4. **Report issue**:
   - GitHub: https://github.com/Edmonds-Commerce-Limited/claude-code-hooks-daemon/issues
   - Include: version info, config file, daemon logs

## References

- [Upgrade system documentation](../../README.md)
- [Project handlers guide](../../../PROJECT_HANDLERS.md)
- [Handler development guide](../../../HANDLER_DEVELOPMENT.md)
- [Commit removing handlers](https://github.com/Edmonds-Commerce-Limited/claude-code-hooks-daemon/commit/990bb1f)
