# Upgrade Guide: v2.11 → v2.12

## Summary

This upgrade renames and significantly enhances the ESLint validation handler. The `validate_eslint_on_write` handler is now `lint_on_edit` with support for **9 programming languages** using a Strategy Pattern architecture.

**This is a positive upgrade**: You get the same ESLint functionality for JavaScript/TypeScript PLUS 8 additional languages with a simple config rename.

**Breaking Changes**:
- Renamed handler: `validate_eslint_on_write` → `lint_on_edit`
- Extended functionality from ESLint-only to 9 languages with Strategy Pattern

**Impact**: Low - Simple rename in config file, functionality preserved and expanded

## Version Compatibility

- **Source Version**: v2.11.0
- **Target Version**: v2.12.0
- **Minimum Claude Code Version**: Any
- **Supports Rollback**: Yes
- **Breaking Changes**: Yes (handler rename)
- **Config Migration Required**: Yes (simple rename)

## Pre-Upgrade Checklist

Before starting the upgrade:

- [ ] Backup `.claude/hooks-daemon.yaml`
  ```bash
  cp .claude/hooks-daemon.yaml .claude/hooks-daemon.yaml.backup
  ```
- [ ] Check if you use the old handler name
  ```bash
  grep "validate_eslint_on_write" .claude/hooks-daemon.yaml
  ```
- [ ] Check current version
  ```bash
  cd .claude/hooks-daemon
  cat src/claude_code_hooks_daemon/version.py  # Should show 2.11.0
  ```
- [ ] Verify daemon status
  ```bash
  untracked/venv/bin/python -m claude_code_hooks_daemon.daemon.cli status
  ```

## Changes Overview

### Handler Rename and Enhancement

#### From: validate_eslint_on_write (PostToolUse)

**What it did**: Ran ESLint validation after Write/Edit operations on JavaScript/TypeScript files.

**Limitations**:
- ESLint only (JavaScript/TypeScript)
- No support for other languages
- Single-purpose implementation

#### To: lint_on_edit (PostToolUse)

**What it does**: Runs language-aware lint validation after Write/Edit operations on files in **9 programming languages**.

**New Capabilities**:
- **9 languages supported** (including JavaScript/TypeScript via ESLint)
- **Strategy Pattern architecture** - clean, extensible design
- **Default + Extended linting** - built-in linters plus optional extended tools
- **Config overrides** - customize lint commands per language
- **Graceful degradation** - continues if linter not installed
- **Priority 25** (code quality tier), non-terminal

### Supported Languages

| Language | Extensions | Default Lint Command | Extended Lint Tool |
|----------|-----------|---------------------|-------------------|
| **Python** | `.py` | `python -m py_compile` | `ruff` |
| **JavaScript/TypeScript** | `.js`, `.ts`, `.jsx`, `.tsx` | `eslint` | - |
| **Ruby** | `.rb` | `ruby -c` | `rubocop` |
| **PHP** | `.php` | `php -l` | `phpcs` |
| **Go** | `.go` | `go vet` | `golangci-lint` |
| **Rust** | `.rs` | `rustc --parse-only` | `clippy` |
| **Java** | `.java` | - | `checkstyle` |
| **C/C++** | `.c`, `.cpp`, `.cc`, `.cxx`, `.h`, `.hpp` | - | `clang-tidy` |
| **Shell** | `.sh`, `.bash` | `bash -n` | `shellcheck` |

**Note**: JavaScript/TypeScript maintains ESLint support - you keep your existing ESLint functionality.

### Architecture Improvements

**Before (v2.11)**: Single-purpose handler with hardcoded ESLint logic

**After (v2.12)**: Strategy Pattern with Protocol interface
- `LintStrategy` Protocol - defines language-specific behavior
- `LintStrategyRegistry` - manages language strategies
- Per-language strategies - independently testable
- Zero language awareness in handler - all logic delegated to strategies

**Benefits**:
- Clean separation of concerns (SOLID principles)
- Easy to add new languages
- Each language independently tested
- Config-driven language filtering
- Command overrides per language

### Configuration Changes

**Before v2.12** (old handler name):
```yaml
handlers:
  post_tool_use:
    validate_eslint_on_write:  # OLD NAME
      enabled: true
      priority: 25
```

**After v2.12** (new handler name with expanded capabilities):
```yaml
handlers:
  post_tool_use:
    lint_on_edit:  # NEW NAME
      enabled: true
      priority: 25
      # Optional: Restrict to specific languages (default: ALL)
      # options:
      #   languages:
      #     - JavaScript/TypeScript
      #     - Python
      # Optional: Override lint commands per language
      # options:
      #   command_overrides:
      #     Python:
      #       default: "ruff check {file}"
      #       extended: null
      #     Shell:
      #       default: "bash -n {file}"
      #       extended: "shellcheck -x {file}"
```

### Key Features

#### 1. Language Filtering

Restrict linting to specific languages:

```yaml
lint_on_edit:
  enabled: true
  options:
    languages:
      - Python
      - JavaScript/TypeScript
      - Go
```

If not specified, ALL 9 languages are enforced.

#### 2. Command Overrides

Customize lint commands per language:

```yaml
lint_on_edit:
  enabled: true
  options:
    command_overrides:
      Python:
        default: "ruff check {file}"  # Use ruff instead of py_compile
        extended: null                # Disable extended linting
      Shell:
        default: "bash -n {file}"
        extended: "shellcheck -x {file}"  # Enable cross-file analysis
```

#### 3. Graceful Degradation

If a linter is not installed, the handler allows the operation through with a warning:

```
Lint tool not found: shellcheck (skipping)
```

No interruption to your workflow if tools aren't available.

#### 4. Default + Extended Linting

Each language can have two lint commands:
- **Default**: Built-in language linter (fast, basic checks)
- **Extended**: Additional tool (comprehensive checks)

Both run if extended is configured and default passes.

## Step-by-Step Upgrade Instructions

### 1. Update Daemon Code

```bash
cd .claude/hooks-daemon
git fetch origin
git checkout v2.12.0
# Or for latest: git pull origin main
```

### 2. Update Dependencies

```bash
cd .claude/hooks-daemon
untracked/venv/bin/pip install -e .
```

**Expected output**:
```
Successfully installed claude-code-hooks-daemon-2.12.0
```

### 3. Update Configuration File

**File**: `.claude/hooks-daemon.yaml`

**Action**: Rename handler from `validate_eslint_on_write` to `lint_on_edit`

**Supporting Files in This Directory**:
- `config-before.yaml` - Example v2.11 config with old handler name
- `config-after.yaml` - Example v2.12 config with new handler name
- `migration-script.sh` - Automated migration script

**Option 1 - Automatic Migration** (recommended):

```bash
cd .claude/hooks-daemon
bash CLAUDE/UPGRADES/v2/v2.11-to-v2.12/migration-script.sh
```

This script will:
- Detect if old handler name exists in your config
- Automatically rename to new handler name
- Preserve all settings (priority, enabled status)
- Show before/after diff
- Verify YAML syntax after change

**Option 2 - Manual Migration**:

1. Open `.claude/hooks-daemon.yaml`
2. Find `validate_eslint_on_write` under `handlers.post_tool_use`
3. Rename to `lint_on_edit`
4. Keep all other settings unchanged

**Example manual edit**:
```yaml
handlers:
  post_tool_use:
    # OLD (v2.11):
    # validate_eslint_on_write:
    #   enabled: true
    #   priority: 25

    # NEW (v2.12):
    lint_on_edit:
      enabled: true
      priority: 25
```

**Why This Change**:

The old name `validate_eslint_on_write` was too specific. The new handler supports 9 languages, not just ESLint. The new name `lint_on_edit` accurately reflects its broader capabilities.

**Architecture Improvement**:

The new handler uses Strategy Pattern (same architecture as TDD and QA suppression handlers). Each language is a separate strategy, making the code:
- More maintainable (SOLID principles)
- Easier to test (each strategy independently tested)
- Easier to extend (add new languages without modifying handler)
- Config-driven (filter languages, override commands)

### 4. Optional: Configure Language Support

**By default**, all 9 languages are enforced. If you only want specific languages:

```yaml
handlers:
  post_tool_use:
    lint_on_edit:
      enabled: true
      priority: 25
      options:
        languages:
          - JavaScript/TypeScript  # Keep ESLint for JS/TS
          - Python                 # Add Python linting
```

**If you were only using ESLint before**, you can restrict to JavaScript/TypeScript to maintain the same behavior:

```yaml
options:
  languages:
    - JavaScript/TypeScript
```

### 5. Optional: Install Extended Linters

Extended linters provide more comprehensive checking:

```bash
# Python: ruff (fast Python linter)
pip install ruff

# Shell: shellcheck (shell script linter)
apt-get install shellcheck  # Or: brew install shellcheck

# Ruby: rubocop
gem install rubocop

# Go: golangci-lint
go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest

# Rust: clippy (usually included with rustup)
rustup component add clippy

# PHP: phpcs
composer global require "squizlabs/php_codesniffer=*"

# Java: checkstyle
# Download from https://checkstyle.org/

# C/C++: clang-tidy (usually included with clang)
apt-get install clang-tidy  # Or: brew install llvm
```

**Note**: Extended linters are optional. If not installed, handler gracefully degrades to default linter only.

### 6. Hook Scripts

**No action needed** - Hook scripts are unchanged, handler is just renamed in the registry.

### 7. Restart Daemon (if running)

```bash
cd .claude/hooks-daemon
untracked/venv/bin/python -m claude_code_hooks_daemon.daemon.cli restart
```

**Expected output**:
```
Daemon stopped successfully
Daemon started with PID: XXXXX
```

**Note**: With lazy startup, daemon may not be running. That's normal.

## Breaking Changes

### Handler Rename

**validate_eslint_on_write** is completely removed and replaced with **lint_on_edit**.

**Impact**:
- If your config references the old name, it will be silently ignored (no error)
- Functionality is preserved and expanded - ESLint still works for JS/TS
- Simple config rename required

**Who is affected**:
- Projects that explicitly enabled `validate_eslint_on_write` in config
- Projects relying on ESLint validation after Write/Edit

**Not affected**:
- Projects that never configured this handler
- Projects using other handlers only

**Migration**: Simple rename in config file (see migration instructions above)

## What You Get

### Immediate Benefits

1. **JavaScript/TypeScript support preserved** - ESLint still works exactly as before
2. **8 additional languages** - Python, Ruby, PHP, Go, Rust, Java, C/C++, Shell
3. **Configurable** - Filter languages, override commands
4. **Graceful** - Continues if linter not installed
5. **Fast** - Built-in linters run quickly (py_compile, bash -n, etc.)
6. **Comprehensive** - Optional extended linters for deeper checks

### Example: Multi-Language Project

If you work on a project with Python backend, TypeScript frontend, and shell scripts:

```yaml
lint_on_edit:
  enabled: true
  options:
    languages:
      - Python
      - JavaScript/TypeScript
      - Shell
    command_overrides:
      Python:
        extended: "ruff check {file}"  # Use ruff for Python
      Shell:
        extended: "shellcheck {file}"  # Use shellcheck for shell
```

Now you get instant linting feedback for all three languages!

## Verification Steps

### 1. Verify Version Updated

```bash
cd .claude/hooks-daemon
cat src/claude_code_hooks_daemon/version.py
```

**Expected output**:
```python
__version__ = "2.12.0"
```

### 2. Verify Configuration Syntax

```bash
cd .claude/hooks-daemon
untracked/venv/bin/python -c "import yaml; yaml.safe_load(open('../../.claude/hooks-daemon.yaml'))"
```

**Expected**: No output (valid YAML)

### 3. Verify Daemon Starts

```bash
cd .claude/hooks-daemon
untracked/venv/bin/python -m claude_code_hooks_daemon.daemon.cli restart
```

**Expected**: Daemon starts successfully without errors

### 4. Verify Handler Loaded

```bash
cd .claude/hooks-daemon
untracked/venv/bin/python -m claude_code_hooks_daemon.daemon.cli restart
tail -50 .claude/hooks-daemon/untracked/daemon.log | grep -i "lint_on_edit"
```

**Expected**: Handler loaded successfully (no errors about missing handler)

### 5. Test Linting (if handler enabled)

**Python test** (if Python in languages):
```bash
# Create a file with syntax error
echo "def broken(" > /tmp/test.py

# Edit it in Claude Code - should see lint error
```

**JavaScript test** (if JavaScript/TypeScript in languages):
```bash
# Create a file with ESLint issues
echo "var x = 1" > /tmp/test.js

# Edit it in Claude Code - should see ESLint errors
```

**Shell test** (if Shell in languages):
```bash
# Create a shell script with syntax error
echo "if [ true" > /tmp/test.sh

# Edit it in Claude Code - should see bash syntax error
```

### 6. Run Automated Verification

```bash
cd .claude/hooks-daemon
bash CLAUDE/UPGRADES/v2/v2.11-to-v2.12/verification.sh
```

**Expected output**:
```
✅ Version check: PASS (v2.12.0)
✅ Config validation: PASS (no old handler name)
✅ Handler loaded: PASS (lint_on_edit found)
✅ Daemon restart: PASS

=== All Verification Checks Passed ===
```

## Rollback Instructions

If you need to revert to v2.11.0:

### 1. Stop Daemon

```bash
cd .claude/hooks-daemon
untracked/venv/bin/python -m claude_code_hooks_daemon.daemon.cli stop
```

### 2. Restore Configuration

```bash
cp .claude/hooks-daemon.yaml.backup .claude/hooks-daemon.yaml
```

### 3. Revert Code

```bash
cd .claude/hooks-daemon
git checkout v2.11.0
```

### 4. Reinstall Dependencies

```bash
untracked/venv/bin/pip install -e .
```

### 5. Verify Rollback

```bash
cat src/claude_code_hooks_daemon/version.py
# Should show: __version__ = "2.11.0"
```

### 6. Restart Daemon

```bash
untracked/venv/bin/python -m claude_code_hooks_daemon.daemon.cli restart
```

## Known Issues

### ESLint Configuration

If you have custom ESLint configuration (`.eslintrc`, `eslint.config.js`), it continues to work. The handler runs ESLint the same way as before.

### Extended Linters Not Installed

If extended linters (ruff, shellcheck, rubocop, etc.) are not installed, the handler gracefully degrades:

```
Lint tool not found: ruff (skipping)
```

No errors, no interruptions. Default linters still run if available.

### Performance

Linting runs synchronously after Write/Edit. For large files, this may add a small delay (typically < 1 second). If this is an issue:

```yaml
lint_on_edit:
  enabled: false  # Disable if linting causes delays
```

Or restrict to specific languages to reduce overhead.

## Configuration Examples

### Minimal Config (JavaScript/TypeScript Only)

Maintain v2.11 behavior - ESLint only:

```yaml
handlers:
  post_tool_use:
    lint_on_edit:
      enabled: true
      priority: 25
      options:
        languages:
          - JavaScript/TypeScript
```

### Multi-Language Config

Enable linting for multiple languages:

```yaml
handlers:
  post_tool_use:
    lint_on_edit:
      enabled: true
      priority: 25
      options:
        languages:
          - Python
          - JavaScript/TypeScript
          - Shell
          - Go
        command_overrides:
          Python:
            extended: "ruff check {file}"
          Shell:
            extended: "shellcheck {file}"
```

### All Languages (Default)

Enable linting for all 9 languages (no options needed):

```yaml
handlers:
  post_tool_use:
    lint_on_edit:
      enabled: true
      priority: 25
```

### Custom Lint Commands

Override default commands per language:

```yaml
handlers:
  post_tool_use:
    lint_on_edit:
      enabled: true
      priority: 25
      options:
        command_overrides:
          Python:
            default: "/usr/bin/python3.11 -m py_compile {file}"  # Custom Python path
            extended: "ruff check --select=E,W {file}"           # Only errors/warnings
          Shell:
            default: "bash -n {file}"
            extended: null  # Disable shellcheck
```

### Disabled Extended Linting

Use only default linters (faster, less comprehensive):

```yaml
handlers:
  post_tool_use:
    lint_on_edit:
      enabled: true
      priority: 25
      options:
        command_overrides:
          Python:
            extended: null
          Shell:
            extended: null
          Ruby:
            extended: null
```

## Additional Notes

### Why This Change?

The old handler was ESLint-specific and couldn't support other languages. The Strategy Pattern architecture allows:

1. **Extensibility** - Add new languages without modifying handler
2. **Testability** - Each language strategy independently tested (95%+ coverage)
3. **Maintainability** - Clean separation of concerns (SOLID principles)
4. **Configurability** - Language filtering and command overrides
5. **Consistency** - Same pattern as TDD and QA suppression handlers

### Architecture Benefits

**Strategy Pattern** (used by 3 handlers now):
- `TddEnforcementHandler` - 11 language TDD strategies
- `QaSuppressionHandler` - 11 language QA strategies
- `LintOnEditHandler` - 9 language lint strategies

**Benefits**:
- Consistent architecture across handlers
- Proven pattern (already successful in 2 handlers)
- Easy to add new languages to any handler
- Config-driven language support

### Performance

Linting adds minimal overhead:
- **Default linters**: < 100ms (py_compile, bash -n, etc.)
- **Extended linters**: 100-500ms (ruff, shellcheck, etc.)
- **Only runs on Write/Edit**: No impact on other tools

For large files or slow linters, you can:
1. Disable extended linting (keep default only)
2. Restrict to specific languages
3. Disable handler entirely

### Compatibility

- Works with all Claude Code versions
- Compatible with all existing handlers
- No dependency changes
- No new system requirements

### Future Enhancements

Potential improvements (not in v2.12.0):
- Async linting (non-blocking)
- Caching lint results
- Configurable timeout per language
- Support for custom lint commands (not just overrides)

These are not committed - we follow YAGNI (implement what's needed now).

## Support

If you encounter issues:

1. **Check config is valid**:
   ```bash
   cd .claude/hooks-daemon
   untracked/venv/bin/python -c "import yaml; yaml.safe_load(open('../../.claude/hooks-daemon.yaml'))"
   ```

2. **Check daemon logs**:
   ```bash
   cat .claude/hooks-daemon/untracked/daemon.log
   ```

3. **Verify handler loaded**:
   ```bash
   cd .claude/hooks-daemon
   untracked/venv/bin/python -c "from claude_code_hooks_daemon.handlers.post_tool_use import LintOnEditHandler; print('OK')"
   ```

4. **Check for old handler name**:
   ```bash
   grep -n "validate_eslint_on_write" .claude/hooks-daemon.yaml
   ```

5. **Report issue**:
   - GitHub: https://github.com/Edmonds-Commerce-Limited/claude-code-hooks-daemon/issues
   - Include: version info, config file, daemon logs, language being tested

## References

- [Upgrade system documentation](../../README.md)
- [Plan 00054 - Lint-on-Edit Strategy Pattern](../../../Plan/Completed/00054-lint-on-edit-strategy-pattern/PLAN.md)
- [Handler development guide](../../../HANDLER_DEVELOPMENT.md)
- [Strategy Pattern documentation](../../../ARCHITECTURE.md#strategy-pattern)
- [CHANGELOG.md](../../../../CHANGELOG.md) (v2.12.0 entry)
- [Commit 340d806](https://github.com/Edmonds-Commerce-Limited/claude-code-hooks-daemon/commit/340d806) - Initial lint strategy implementation
