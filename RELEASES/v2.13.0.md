# Release v2.13.0 - ReleaseBlockerHandler & Single Daemon Process Enforcement

**Release Date:** 2026-02-17
**Type:** Minor Release
**Previous Version:** v2.12.0

## Summary

Version 2.13.0 introduces the ReleaseBlockerHandler to enforce acceptance testing gates during releases, preventing AI agents from skipping critical validation steps. This release also adds single daemon process enforcement for container environments, fixes critical PHP QA suppression pattern gaps that allowed quality control bypasses, and makes acceptance testing methodology realistic and achievable. Additionally, it enhances plan execution guidance with clear model capability documentation and fixes bugs in the MarkdownOrganizationHandler.

## Highlights

- **ReleaseBlockerHandler**: Prevents session ending during releases until acceptance tests complete
- **Single Daemon Process Enforcement**: Prevents multiple daemon instances in containers
- **PHP QA Suppression Fix**: Critical security fix for bypassed quality controls
- **Realistic Acceptance Testing**: Reduced from 127+ unrealistic tests to 89 achievable tests
- **Plan Execution Framework**: Clear guidance on model capabilities for plan orchestration

## Changes

### Added - ReleaseBlockerHandler (Plan 00060, commits 1de40fc, 1796310, 6841e8c)

**Feature**: Project-specific Stop event handler that enforces RELEASING.md Step 8 acceptance testing gate by blocking Claude from stopping during releases.

**Problem**: During v2.13.0 development, AI agents attempted to skip acceptance testing by ending the session prematurely, violating the release process.

**Solution**: Handler detects release context and blocks Stop events until acceptance tests are complete.

**Handler Behavior**:
- **Priority**: 12 (before AutoContinueStop at 15)
- **Terminal**: Terminal (blocks Stop events)
- **Event**: Stop
- **Location**: `.claude/project-handlers/stop/release_blocker.py` (project-specific, not library handler)

**Detection Logic**:
Checks for modified release files via git status:
- `pyproject.toml` (version changes)
- `src/claude_code_hooks_daemon/version.py` (version changes)
- `README.md` (badge updates)
- `CHANGELOG.md` (changelog entries)
- `RELEASES/*.md` (release notes)

**Safety Features**:
- Prevents infinite loops via `stop_hook_active` flag
- Fails safely on git errors (silent allow)
- Clear message referencing RELEASING.md Step 8

**Example Block Message**:
```
üö´ BLOCKED: Session cannot end during active release

Release files modified:
  - pyproject.toml
  - src/claude_code_hooks_daemon/version.py
  - CHANGELOG.md
  - RELEASES/v2.13.0.md

You must complete acceptance testing before ending the session.
See: @CLAUDE/development/RELEASING.md Step 8

After completing acceptance tests, commit release files to proceed.
```

**Configuration**:
```yaml
# No configuration needed - auto-discovered as project handler
project_handlers:
  enabled: true
  path: .claude/project-handlers
```

**Testing**:
- 22 unit tests covering all detection logic
- 4 integration tests for daemon compatibility
- All QA checks pass (7/7)
- Daemon loads successfully

**Impact**: Addresses AI acceptance test avoidance behavior, ensuring releases follow proper validation gates.

### Added - Single Daemon Process Enforcement (Plan 00057, commits fc43d03, 3b0df03, 17b3420, c4270d3, 609a2ef, a491809, c07e2bb, 6c38904, 6b6adca)

**Feature**: New `enforce_single_daemon_process` configuration option prevents multiple daemon instances from running simultaneously.

**Problem**: In container environments, multiple daemon instances could start and conflict with each other, causing socket contention and PID file confusion.

**Solution**: Container-aware enforcement with aggressive cleanup in containers, conservative cleanup elsewhere.

**Configuration**:
```yaml
daemon:
  enforce_single_daemon_process: true  # Auto-enabled in containers
```

**Behavior by Environment**:

**In containers (YOLO mode, Docker, Podman)**:
- Auto-enabled during `daemon init`
- Kills ALL other daemon processes system-wide on startup
- Uses SIGTERM with 2-second timeout, then SIGKILL
- Ensures clean daemon lifecycle in isolated environments

**Outside containers**:
- Only cleans up stale PID files for current project
- Safe for multi-user and multi-project environments
- Conservative approach prevents disrupting other projects

**Implementation Details**:
- Container detection via environment variables (CLAUDE_PROJECT_YOLO, CONTAINER, DOCKER, PODMAN)
- Process verification via psutil (PID + command-line matching)
- Graceful shutdown with timeout (Timeout.PROCESS_KILL_WAIT = 2 seconds)
- Safe process termination with permission error handling

**When to Enable**:
- ‚úÖ Container environments (auto-enabled)
- ‚úÖ Single-user development machines
- ‚ùå Shared servers with multiple users/projects

**Testing**:
- 40 new tests added
- 95.1% coverage maintained
- 0 regressions
- Daemon startup/restart verified

**Impact**: Prevents daemon conflicts in containers, ensures clean daemon lifecycle management.

### Added - Plan Execution Strategy Framework (commit b960f23)

**Feature**: Added execution strategy guidance to planning workflow for optimal plan orchestration.

**Strategy Selection Matrix**:

| Plan Complexity | Recommended Model | Execution Strategy | Rationale |
|----------------|-------------------|-------------------|-----------|
| Simple | Sonnet 4.5 | Sub-Agent Orchestration | Sonnet delegates independent tasks |
| Medium | Sonnet 4.5 | Sub-Agent Orchestration | Sonnet coordinates sequential phases |
| Complex | Opus 4.6 | Sub-Agent Teams | Opus manages team coordination |
| Critical | Opus 4.6 | Sub-Agent Teams | Opus provides strategic oversight |

**Three Execution Strategies**:
1. **Single-Threaded**: Main agent executes all work directly (quick fixes, docs)
2. **Sub-Agent Orchestration**: Main agent spawns specialized sub-agents for parallel tasks (Sonnet preferred)
3. **Sub-Agent Teams**: Main agent creates team with task list, members claim tasks (Opus preferred)

**New Plan Header Fields**:
```markdown
**Recommended Executor**: Opus | Sonnet
**Execution Strategy**: Sub-Agent Orchestration | Sub-Agent Teams | Single-Threaded
```

**Impact**: Plans now guide optimal execution approach based on complexity, reducing trial-and-error.

### Changed - Acceptance Testing Methodology (commit 7cd9baa)

**Problem**: Previous process demanded ALL 127+ tests be executed, including many untestable handlers (SessionEnd fires at session end, PreCompact untriggerable). Time estimate was unrealistic and process became a farce.

**Solution**: Categorized tests into three groups based on verification method:

**1. EXECUTABLE (89 tests - 20-30 min)**:
- 65 Blocking + 24 Advisory PreToolUse/PostToolUse handlers
- Must be tested by running commands in main thread
- Example: Test destructive git blocker by running `git reset --hard`

**2. OBSERVABLE (10 tests - 30 sec)**:
- SessionStart/UserPromptSubmit/PostToolUse lifecycle handlers
- Just verify messages visible in system-reminders
- Example: Check SessionStart handler shows in context

**3. VERIFIED_BY_LOAD (30 tests - 0 min)**:
- SessionEnd/PreCompact/Stop/SubagentStop/Status/Notification/PermissionRequest
- Cannot be triggered on demand
- Verified by daemon loading successfully + unit tests passing
- Skip these tests entirely

**Changes Made**:
- Updated RELEASING.md Step 8 with realistic categories and time estimates
- Enhanced GENERATING.md with category documentation
- Added comprehensive TestType enum documentation
- Updated playbook generator to annotate tests with category guidance
- Playbook now shows "(OBSERVABLE - check system-reminders)" or "(VERIFIED_BY_LOAD - skip test)"

**Impact**:
- Acceptance testing now takes 20-30 minutes (realistic)
- Clear expectations about what to test vs skip
- No more confusion about untestable handlers
- Process is now achievable every release

### Changed - Plan Execution Guidance (commits 2983fa6, bc10236)

**Problem**: Soft language and unclear guidance about which AI models could orchestrate plans.

**Solution**: Direct, unambiguous documentation of model capabilities.

**Key Changes**:
- **CRITICAL**: Haiku 4.5 CANNOT orchestrate plans (only Opus/Sonnet)
- Removed all waffling and soft language ("NOT recommended" ‚Üí "CANNOT")
- Minimum: Sonnet 4.5 for plan orchestration (hard requirement)
- Clear guidance on when to use Opus vs Sonnet for plan execution
- Haiku suitable only for: utility scripts, basic file operations, team support roles

**Rationale**:
- Haiku lacks context window for effective orchestration
- Haiku cannot coordinate sub-agents or manage complexity
- Haiku best used for simple utility tasks, not strategic work

**Impact**: Eliminates confusion about model selection for plan execution.

### Changed - MarkdownOrganizationHandler (Plan 00059, commits b496d68, 8f1d0df, 38b9d42)

**Enhancement**: Added support for plan subdirectories (Completed/, Cancelled/, Archive/).

**Problem**: Handler blocked edits to `CLAUDE/Plan/Completed/` paths because pattern validation rejected 'Completed' as a folder name (no numeric prefix).

**Solution**: Handler now allows edits to plan subdirectories while maintaining active plan validation.

**Implementation**:
- Added `_PLAN_SUBDIRECTORIES` constant: ("Completed", "Cancelled", "Archive")
- Fixed validation logic to check subdirectory paths correctly
- For subdirs, validates second path segment instead of first
- 5 new tests added, all 89 handler tests pass

**Side Effect**: Updated 5 completed plans with proper status and completion dates (Plans 00048-00052).

**Impact**: Documentation maintenance no longer blocked for archived plans.

### Fixed - PHP QA Suppression Pattern Gaps (Plan 00058, commits 6ae79e4, 7252bfe)

**CRITICAL BUG FIX**: PHP QA suppression handler was missing 8 patterns, allowing developers to bypass quality controls.

**Severity**: SECURITY - User reported "serious issues" in their project due to unblocked suppressions.

**Missing Patterns Now Blocked**:
- `@phpstan-ignore` (modern identifier-specific suppression)
- `phpcs:disable` / `phpcs:enable` (block-level suppression)
- `phpcs:ignoreFile` (entire file suppression)
- `@codingStandardsIgnoreStart/End/File` (deprecated but still used)

**Root Cause**: Forbidden patterns list only covered older/partial syntax, missing modern PHPStan v1.11+ patterns and PHPCS block-level controls.

**Fix Details**:
- Added 8 missing patterns to `php_strategy.py`
- All patterns now use string concatenation to avoid self-matching
- Added 8 comprehensive TDD regression tests (RED ‚Üí GREEN cycle verified)
- Added 3 acceptance tests for critical patterns

**Research Sources**:
- PHPStan: https://phpstan.org/user-guide/ignoring-errors
- Psalm: https://psalm.dev/docs/annotating_code/supported_annotations/
- PHPCS: https://github.com/squizlabs/PHP_CodeSniffer/wiki/Advanced-Usage

**Testing**:
- 21/21 unit tests pass (8 new regression tests)
- Live acceptance testing verified all patterns blocked
- Daemon restarts successfully
- All QA checks pass (7/7)

**Impact**: Quality control enforcement restored, prevents suppression abuse.

### Fixed - QA Issues (commit c4270d3)

**Fix**: Resolved magic value violations and type errors after Plan 00057 Phase 2 & 3.

**Changes**:
- Added `Timeout.PROCESS_KILL_WAIT` constant (2 seconds)
- Updated `process_verification.py` to use constant
- Properly typed psutil optional import with `ModuleType | None` annotation
- Removed unnecessary `type: ignore` comment

**Impact**: Maintains zero magic value violations and strict type checking compliance.

### Fixed - Black Formatting (commit 609a2ef)

**Fix**: Applied Black formatting to `test_enforcement.py`.

**Impact**: All format checks pass.

## Installation

### New Users

```bash
# Clone repository at v2.13.0
git clone -b v2.13.0 https://github.com/Edmonds-Commerce-Limited/claude-code-hooks-daemon.git
cd claude-code-hooks-daemon

# Install (requires Python 3.11+)
python3 -m venv untracked/venv
untracked/venv/bin/pip install -e .
untracked/venv/bin/python -m claude_code_hooks_daemon.install.installer
```

### Existing Users

```bash
# Navigate to installation directory
cd .claude/hooks-daemon/

# Pull latest changes
git fetch --tags
git checkout v2.13.0

# Reinstall dependencies
untracked/venv/bin/pip install -e .

# Restart daemon (automatically reloads)
untracked/venv/bin/python -m claude_code_hooks_daemon.daemon.cli restart
```

## Upgrade Notes

### Configuration Changes

**Single Daemon Process Enforcement** (Auto-enabled in containers):

If you're running in a container environment, the installer will auto-enable this setting. To enable manually:

```yaml
# .claude/hooks-daemon.yaml
daemon:
  enforce_single_daemon_process: true
```

**When to enable**:
- ‚úÖ Container environments (Docker, Podman, YOLO mode)
- ‚úÖ Single-user development machines
- ‚ùå Shared servers with multiple users/projects

**Behavior**:
- Container: Terminates all other `hooks-daemon` processes (SIGTERM ‚Üí SIGKILL)
- Non-container: Only removes stale PID files for current project

### Breaking Changes

**None** - This release is fully backwards-compatible.

### Project Handlers

**ReleaseBlockerHandler** is auto-discovered as a project handler. No configuration needed if `project_handlers.enabled: true` (default).

## Testing

### Test Statistics

- **Total Tests**: 5,663 passing, 0 failed, 3 skipped
- **Coverage**: 95.0% (maintained strict requirement)
- **New Tests Added**: 74 tests for ReleaseBlockerHandler, single daemon enforcement, and bug fixes

### QA Checks

All QA checks passing:
- ‚úÖ Magic Values (no magic strings/numbers)
- ‚úÖ Format Check (Black)
- ‚úÖ Linter (Ruff)
- ‚úÖ Type Check (MyPy strict mode)
- ‚úÖ Tests (Pytest with 95% coverage)
- ‚úÖ Security (Bandit - zero issues)
- ‚úÖ Dependencies (deptry - zero issues)

## Contributors

- Claude Sonnet 4.5 (AI Assistant)

## Links

- **GitHub Release**: https://github.com/Edmonds-Commerce-Limited/claude-code-hooks-daemon/releases/tag/v2.13.0
- **Full Changelog**: https://github.com/Edmonds-Commerce-Limited/claude-code-hooks-daemon/compare/v2.12.0...v2.13.0
- **Documentation**: https://github.com/Edmonds-Commerce-Limited/claude-code-hooks-daemon#readme
- **Issue Tracker**: https://github.com/Edmonds-Commerce-Limited/claude-code-hooks-daemon/issues

## Related Plans

- Plan 00060: ReleaseBlockerHandler Implementation
- Plan 00059: Fix MarkdownOrganizationHandler Completed/ Folder Bug
- Plan 00058: Fix PHP QA Suppression Pattern Gaps (CRITICAL)
- Plan 00057: Single Daemon Process Enforcement

---

**Note**: This release prioritizes release process integrity, container environment support, and quality control enforcement. The ReleaseBlockerHandler ensures acceptance testing gates are never bypassed, while single daemon enforcement provides clean lifecycle management in containerized development environments.
