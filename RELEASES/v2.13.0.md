# Release v2.13.0 - Single Daemon Process Enforcement & Critical Bug Fixes

**Release Date**: 2026-02-13
**Release Type**: MINOR (new features, backwards-compatible)
**Previous Version**: v2.12.0

## Summary

This release introduces **single daemon process enforcement** to prevent multiple daemon instances from running simultaneously, particularly important in container environments. It also includes critical bug fixes for PHP QA suppression detection and markdown organization handler edge cases, plus improved acceptance testing methodology documentation.

## Highlights

### üîí Single Daemon Process Enforcement (Plan 00057)

New configuration option `enforce_single_daemon_process` prevents multiple daemon instances:

**In containers (YOLO mode, Docker, Podman)**:
- Automatically enabled during `daemon init`
- Kills ALL other daemon processes system-wide on startup
- Uses SIGTERM with 2-second timeout, then SIGKILL

**Outside containers**:
- Only cleans up stale PID files for current project
- Safe for multi-user and multi-project environments

**Configuration**:
```yaml
daemon:
  enforce_single_daemon_process: true  # Auto-enabled in containers
```

### üêõ Critical Bug Fixes

**MarkdownOrganizationHandler** (Plan 00059):
- Fixed crash when encountering `Completed/` subdirectories in plan folders
- Improved directory traversal logic for nested completion folders

**PHP QA Suppression Handler** (Plan 00058):
- **CRITICAL**: Fixed pattern gaps in PHP suppression comment detection
- Now detects all valid PHPStan, Psalm, and PHPCS suppression formats
- Added comprehensive regression tests

### üìã Acceptance Testing Improvements

Refined acceptance testing methodology (commit 7cd9baa):
- Emphasis on realistic manual execution in main thread
- Clearer guidance for EXECUTABLE, OBSERVABLE, and VERIFIED_BY_LOAD categories
- Updated documentation to reflect practical testing approach

### üìñ Plan Execution Strategy Framework

Clarified model capabilities for plan orchestration:
- **CRITICAL**: Haiku 4.5 CANNOT orchestrate plans (only Opus/Sonnet)
- Documented execution strategy selection matrix
- Clear guidance on when to use Opus vs Sonnet

## Full Changelog

### Added
- **Single Daemon Process Enforcement**: New `enforce_single_daemon_process` configuration option (Plan 00057)
  - Prevents multiple daemon instances from running simultaneously
  - Container-aware: Aggressive cleanup in containers, conservative outside
  - Auto-detection during config generation
  - 2-second graceful shutdown timeout before force kill

### Changed
- **Acceptance Testing Methodology**: Shifted to realistic manual testing approach
  - Emphasizes main-thread execution for accuracy
  - Improved test category documentation

- **Plan Execution Strategy Framework**: Clarified model orchestration capabilities
  - Haiku 4.5 cannot orchestrate plans (Opus/Sonnet only)
  - Documented strategy selection matrix
  - Model-specific execution guidance

### Fixed
- **MarkdownOrganizationHandler Completed/ Folder Bug**: Fixed crash with nested completion folders (Plan 00059)
  - Handler now handles `Completed/` subdirectories correctly
  - Updated traversal logic with comprehensive edge case testing

- **PHP QA Suppression Pattern Gaps**: Fixed critical detection bug (Plan 00058)
  - Extended regex patterns for all PHP QA tools (PHPStan, Psalm, PHPCS)
  - Added regression tests for all suppression comment formats

## Installation

### New Users

```bash
# Clone repository at v2.13.0
git clone -b v2.13.0 https://github.com/LongTermSupport/claude-code-hooks-daemon.git
cd claude-code-hooks-daemon

# Install (requires Python 3.11+)
python3 -m claude_code_hooks_daemon.install.installer
```

### Existing Users

```bash
# Navigate to installation directory
cd ~/.claude/hooks-daemon/

# Pull latest changes
git fetch --tags
git checkout v2.13.0

# Restart daemon (automatically reloads)
python3 -m claude_code_hooks_daemon.daemon.cli restart
```

## Upgrade Notes

### Configuration Changes

**Single Daemon Process Enforcement** (Optional but Recommended):

If you're running in a container environment, the installer will auto-enable this setting. To enable manually:

```yaml
# .claude/hooks-daemon.yaml
daemon:
  enforce_single_daemon_process: true
```

**When to enable**:
- ‚úÖ Container environments (Docker, Podman, YOLO mode)
- ‚úÖ Single-user development machines
- ‚ùå Shared servers with multiple users/projects

**Behavior**:
- Container: Terminates all other `hooks-daemon` processes (SIGTERM ‚Üí SIGKILL)
- Non-container: Only removes stale PID files for current project

### Breaking Changes

**None** - This release is fully backwards-compatible.

## Testing

### Test Statistics

- **Total Tests**: 5,658 passing
- **Coverage**: 95%+ (maintained strict requirement)
- **New Tests Added**: 74 tests for single daemon enforcement and bug fixes

### QA Checks

All QA checks passing:
- ‚úÖ Magic Values (no magic strings/numbers)
- ‚úÖ Format Check (Black)
- ‚úÖ Linter (Ruff)
- ‚úÖ Type Check (MyPy strict mode)
- ‚úÖ Tests (Pytest with 95% coverage)
- ‚úÖ Security (Bandit - zero issues)

## Contributors

- Claude Sonnet 4.5 (AI Assistant)

## Links

- **GitHub Release**: https://github.com/LongTermSupport/claude-code-hooks-daemon/releases/tag/v2.13.0
- **Full Changelog**: https://github.com/LongTermSupport/claude-code-hooks-daemon/compare/v2.12.0...v2.13.0
- **Documentation**: https://github.com/LongTermSupport/claude-code-hooks-daemon#readme
- **Issue Tracker**: https://github.com/LongTermSupport/claude-code-hooks-daemon/issues

## Related Plans

- Plan 00057: Single Daemon Process Enforcement
- Plan 00058: Fix PHP QA Suppression Pattern Gaps
- Plan 00059: Fix MarkdownOrganizationHandler Completed/ Folder Bug

---

**Note**: This release prioritizes stability and container environment support. The single daemon enforcement feature ensures clean daemon lifecycle management in containerized development environments.
