# Release v2.10.0 - Upgrade System Overhaul & Robustness Improvements

**Release Date:** 2026-02-11
**Type:** Minor Release

## Summary

Version 2.10.0 represents a comprehensive overhaul of the upgrade system with critical fixes for installation robustness, socket path handling, and configuration validation UX. This release resolves fundamental upgrade workflow issues that could lead to broken installations, adds Python 3.11+ version detection to prevent cryptic failures, implements socket path length validation with intelligent fallbacks, and dramatically improves configuration error messages with fuzzy field suggestions.

## Highlights

- **Upgrade System Root Cause Fix**: checkout-first-then-delegate pattern eliminates "upgrade to broken version" failure mode
- **Nested Install Prevention**: Detects and prevents corrupted `.claude/hooks-daemon/hooks-daemon/` directory structures
- **Python 3.11+ Version Detection**: Bash scripts validate Python version before installation/upgrade, preventing cryptic failures
- **AF_UNIX Socket Path Validation**: 107-character limit enforced with XDG_RUNTIME_DIR → /run/user → /tmp fallback hierarchy
- **Config Validation UX**: User-friendly Pydantic errors with fuzzy field suggestions (e.g., "enabeld" → "Did you mean: enabled?")
- **Comprehensive Documentation**: LLM-UPDATE.md updated with Python requirements, socket troubleshooting, and feedback template

## Changes

### Added - Python 3.11+ Version Detection (Plan 00046 Phase 2, commit ae7ac25)

**Problem**: Users installing with Python 3.10 or older experienced cryptic import errors and venv creation failures without understanding the root cause was an outdated Python version.

**Solution**: All bash scripts now validate Python version meets the 3.11+ requirement before proceeding.

**Scripts Updated**:
- `scripts/prerequisites.sh` - Checks Python version before venv creation
- `scripts/upgrade.sh` - Validates Python version during upgrade workflow
- `scripts/venv.sh` - Ensures compatible Python interpreter used

**User Experience**:
```bash
# Before (cryptic failure)
$ ./install.py
ImportError: cannot import name 'Self' from 'typing'

# After (clear guidance)
$ ./install.py
ERROR: Python 3.11+ is required (found: Python 3.10.12)
Please upgrade Python or specify a compatible interpreter with PYTHON environment variable.
```

**Implementation Details**:
- Extracts Python version using `python3 --version | cut -d' ' -f2`
- Compares major.minor version (e.g., "3.11") against requirement
- Provides actionable error message with current version and requirement
- Respects `PYTHON` environment variable for custom interpreter paths

### Added - Installation Feedback Instructions (commit 6f32b84)

**Enhancement**: Added structured feedback template to `LLM-INSTALL.md` to help users report installation issues.

**Template Includes**:
- Environment details (OS, Python version, shell)
- Installation method used
- Steps taken before failure
- Error messages encountered
- Expected vs actual behavior

**Purpose**: Helps identify common installation pain points and improve documentation/tooling based on real user experiences.

### Changed - Upgrade System Root Cause Fix (Plan 00046 Phase 1, commit e3217ab)

**Critical Fix**: Complete overhaul of upgrade workflow to eliminate fundamental failure modes.

**Problem 1: Upgrade to Broken Version**

Before v2.10.0, the upgrade workflow was:
1. Old version's upgrade.sh runs
2. Old script fetches new version code
3. Old script **delegates to new version's upgrade.sh**
4. If new version's upgrade.sh is broken → upgrade fails

This "trust-the-future" pattern caused upgrade failures when new versions had upgrade script bugs.

**Solution**: checkout-first-then-delegate pattern
1. upgrade.sh checks out target version code
2. upgrade.sh **validates the checkout succeeded**
3. upgrade.sh runs the **target version's scripts directly** (no delegation)
4. Target version's scripts handle the upgrade

**Problem 2: Nested Installations**

Some upgrade paths created corrupted directory structures:
```
.claude/
  hooks-daemon/
    hooks-daemon/        # NESTED! Wrong!
      src/
      scripts/
```

**Solution**: Nested install detection
- Upgrade script checks for nested `hooks-daemon/hooks-daemon/` structure
- Aborts with clear error message if detected
- Guides user to clean reinstall

**Problem 3: Legacy Fallback Mode Confusion**

Old upgrade.sh had dual-mode operation (modern + legacy fallback), causing:
- Maintenance burden (two code paths)
- Confusion about which path was used
- Untested edge cases in fallback mode

**Solution**: Single source of truth
- Dropped legacy fallback mode completely
- upgrade.sh is now the only upgrade mechanism
- Simpler, more testable, more maintainable

### Changed - Socket Path Length Validation (Plan 00046 Phase 3, commits 98e6d5f, 5126237, 964ae31)

**Critical Fix**: AF_UNIX socket paths must be ≤ 107 characters (Linux kernel limit), but daemon didn't validate this, causing cryptic bind() failures.

**Problem**:
```python
# Deep project path
/home/user/very/long/project/path/that/exceeds/the/limit/.claude/hooks-daemon/untracked/daemon-hostname.sock
# 120+ characters → bind() fails with "OSError: AF_UNIX path too long"
```

**Solution**: Three-tier fallback hierarchy with validation

**Tier 1: Project-local (preferred)**
- `.claude/hooks-daemon/untracked/daemon-{hostname}.sock`
- Used if path length ≤ 107 characters
- Best for isolation and project-specific instances

**Tier 2: User runtime directory (XDG standard)**
- `$XDG_RUNTIME_DIR/claude-hooks-{user}/daemon-{hostname}.sock`
- Or `/run/user/$(id -u)/claude-hooks-{user}/daemon-{hostname}.sock`
- Used if Tier 1 path too long
- Isolated per-user runtime directory

**Tier 3: System temp (last resort)**
- `/tmp/claude-hooks-{user}/daemon-{hostname}.sock`
- Used if Tier 1 and Tier 2 paths too long
- Shared temp directory (still user-isolated)

**Implementation**:
- `daemon/paths.py`: Added `_validate_socket_path_length()` function
- Self-install mode detection improved in `_get_untracked_dir()`
- `daemon/server.py`: Catches OSError during bind with actionable error message
- Integration tests: `test_path_isolation_socket_length_fallback.py` verifies behavior

**User Experience**:
```bash
# Before (cryptic failure)
OSError: [Errno 36] File name too long

# After (clear guidance)
ERROR: Socket path too long (120 characters, max 107)
Falling back to XDG_RUNTIME_DIR: /run/user/1000/claude-hooks-user/daemon-hostname.sock
```

### Changed - Config Validation UX Improvements (Plan 00046 Phase 4, commits 2d86d5e, e27ea42)

**Enhancement**: Transformed cryptic Pydantic validation errors into user-friendly messages with fuzzy suggestions.

**Problem**:
```yaml
# User's config with typo
handlers:
  pre_tool_use:
    destructive_git: {enabeld: true, priority: 10}  # Typo: "enabeld"
```

**Before v2.10.0** (cryptic error):
```
ValidationError: 1 validation error for HandlerConfig
handlers.pre_tool_use.destructive_git.enabeld
  extra fields not permitted (type=value_error.extra)
```

**After v2.10.0** (friendly error):
```
Config Validation Error: handlers.pre_tool_use.destructive_git

  Unknown field: "enabeld"
  Did you mean: "enabled"?

Valid fields for this section: enabled, priority, terminal, tags
```

**Features**:
- **Fuzzy Field Suggestions**: Uses Levenshtein distance to suggest correct field names
- **Friendly Error Messages**: Translates Pydantic errors to plain English
- **Context-Aware**: Shows valid fields for each config section
- **Duplicate Priority Logging**: Demoted duplicate priority warnings from WARNING to DEBUG (reduces noise)

**Implementation**:
- `config/validation_ux.py`: New module for user-friendly error formatting
- Fuzzy matching algorithm suggests closest valid field names
- Integration with existing Pydantic validation pipeline
- Type annotations fixed, magic values eliminated (QA compliance)

### Changed - LLM-UPDATE.md Documentation (Plan 00046 Phase 5, commit 38853c9)

**Documentation Overhaul**: Comprehensive updates to upgrade documentation reflecting all improvements.

**New Sections**:
- **Python 3.11+ Requirement**: Clearly documented with detection behavior
- **Socket Path Troubleshooting**: Explains AF_UNIX limits and fallback tiers
- **Feedback Template**: Structured format for reporting upgrade issues
- **Common Failure Modes**: Documents known issues and solutions

**Improved Sections**:
- Upgrade workflow steps updated for checkout-first pattern
- Prerequisites section emphasizes Python version
- Troubleshooting expanded with socket path issues
- Recovery steps for nested installs

### Fixed - Upgrade Script Robustness (Plan 00046 Phase 1)

**Bugs Fixed**:
1. **Upgrade to Broken Version**: Old script delegating to broken new script
2. **Nested Installations**: Corrupted `.claude/hooks-daemon/hooks-daemon/` structures
3. **Legacy Fallback Confusion**: Dual-mode operation causing maintenance issues

**Root Cause Analysis** (Plan 00046 Phase 1):
- Fundamental trust issue: trusting future code before validation
- Directory structure assumptions not enforced
- Over-engineering with unnecessary fallback modes

**Verification**:
- Manual testing with intentionally broken upgrade scripts
- Nested install detection triggers correctly
- Single code path simplifies testing and maintenance

### Fixed - Socket Path Length Failures (Plan 00046 Phase 3)

**Bug**: Daemon startup failed on deep directory paths due to AF_UNIX socket path length limit (107 characters).

**Symptoms**:
- Cryptic "OSError: File name too long" during bind()
- Daemon failed to start with no clear explanation
- Users didn't understand root cause

**Root Cause**: Linux kernel AF_UNIX socket path limit not enforced or validated by daemon code.

**Fix**:
- Pre-validate socket path length before bind()
- Implement three-tier fallback hierarchy
- Catch OSError with actionable error message
- Integration tests verify fallback behavior

**Impact**: Users with deep project paths can now use daemon without manual socket path configuration.

### Fixed - Config Validation Errors (Plan 00046 Phase 4)

**Bug**: Pydantic validation errors were cryptic and didn't help users fix config typos.

**Symptoms**:
- "extra fields not permitted" error for typos
- No suggestions for correct field names
- Users spent time debugging config structure

**Root Cause**: Raw Pydantic errors exposed to end users without translation.

**Fix**:
- Custom error formatter translates Pydantic errors
- Fuzzy matching suggests correct field names
- Context-aware validation messages

**Impact**: Config errors are now self-explanatory with actionable fixes.

### Documentation - Plan 00046 Completion (commit 687cbac)

**Complete Six-Phase Implementation Plan**:

**Phase 1**: Upgrade script root cause fix (checkout-first pattern, nested install prevention)
**Phase 2**: Python 3.11+ version detection in bash scripts
**Phase 3**: Socket path length validation with XDG fallback hierarchy
**Phase 3 Extra**: Self-install mode path detection improvements
**Phase 4**: Config validation UX with fuzzy suggestions
**Phase 5**: LLM-UPDATE.md documentation overhaul

**Documentation Artifacts**:
- `CLAUDE/Plan/00046-upgrade-system-overhaul/PLAN.md` - Complete implementation plan
- Technical decisions documented for each phase
- Success criteria verified for all improvements
- Root cause analysis preserved for future reference

### Documentation - Async Agent Warning (commit e131232)

**Critical Process Warning**: Added warning to `RELEASING.md` about v2.9.0 acceptance testing incident.

**Incident Summary** (v2.9.0 release):
1. Launched 22 parallel acceptance test agents (Haiku)
2. Immediately committed, pushed, tagged, and created GitHub release
3. **Agents were still running** during commit/push/tag operations
4. Violated mandatory blocking gate in Step 8 of RELEASING.md

**The Rule**: Launching agents ≠ completing tests

**Must Do**:
1. Launch all batch agents (parallel execution OK)
2. **BLOCK and WAIT** for every agent to return results
3. **READ and VERIFY** every batch result (failed=0, errors=0)
4. Only then proceed to commit/push/tag

**Must NOT Do**:
- Commit while agents running
- Push while agents running
- Tag while agents running
- Create GitHub releases while agents running
- Assume results will be fine
- Treat "launched" as "passed"

**Warning Added**: Prominent warning box in RELEASING.md Step 8 documenting this critical process violation and prevention measures.

### Style - Black Formatting (commit 86b636e)

**Maintenance**: Auto-formatted `server.py` to comply with Black line length requirements (100 characters).

No functional changes, only whitespace and line break adjustments.

## Upgrade Instructions

This release is backwards compatible. No breaking changes or special upgrade steps required.

**Recommended Upgrade Method**: Fetch and review the upgrade script, then run it:

```bash
# Download the upgrade script
curl -fsSL https://raw.githubusercontent.com/Edmonds-Commerce-Limited/claude-code-hooks-daemon/main/scripts/upgrade.sh -o /tmp/upgrade.sh

# Review it to ensure you're comfortable with what it does
less /tmp/upgrade.sh

# Run it
bash /tmp/upgrade.sh
```

Or use the slash command (if upgrading from v2.5.0+):

```
/hooks-daemon-update
```

**What's Different in This Upgrade**:
- Uses new checkout-first-then-delegate pattern (more robust)
- Detects nested installs and aborts with guidance
- Validates Python 3.11+ before proceeding
- Handles deep project paths with socket fallback

**Configuration Changes**: None required. All improvements are automatic.

## Installation

### New Installations

```bash
cd .claude
git clone -b v2.10.0 https://github.com/Edmonds-Commerce-Limited/claude-code-hooks-daemon.git hooks-daemon
cd hooks-daemon
python3 -m venv untracked/venv
untracked/venv/bin/pip install -e .
untracked/venv/bin/python install.py
```

**Python Requirement**: Python 3.11 or newer required. The installer will validate your Python version before proceeding.

**AI-Assisted Installation (Recommended)**: See [LLM-INSTALL.md](https://raw.githubusercontent.com/Edmonds-Commerce-Limited/claude-code-hooks-daemon/main/CLAUDE/LLM-INSTALL.md)

### Upgrading Existing Installations

**Method 1: Fetch and Review Script (Recommended)**

```bash
# Download the upgrade script
curl -fsSL https://raw.githubusercontent.com/Edmonds-Commerce-Limited/claude-code-hooks-daemon/main/scripts/upgrade.sh -o /tmp/upgrade.sh

# Review it
less /tmp/upgrade.sh

# Run it
bash /tmp/upgrade.sh
```

**Method 2: Using Slash Command** (if upgrading from v2.5.0+)

```
/hooks-daemon-update
```

## Testing

- **Tests**: 5309 passing (24 new tests for upgrade system improvements)
- **Coverage**: 95%+ maintained across all modules
- **Type Safety**: MyPy strict mode compliant
- **Security**: Bandit scan clean (0 issues)
- **QA Checks**: 7 checks passing (Magic Values, Format, Lint, Type Check, Tests, Security, Dependencies)

## Performance

No performance regressions. Socket path fallback adds negligible overhead (one-time path length check at startup).

## Contributors

This release was developed with contributions from:
- Claude Sonnet 4.5

## Migration Notes

### For Users Upgrading from v2.9.0

**No Breaking Changes**: This release is fully backwards compatible.

**Automatic Improvements**:
- Python version validation (prevents installation with outdated Python)
- Socket path fallback (handles deep project paths automatically)
- Config error messages (better UX for typos and mistakes)
- Upgrade reliability (checkout-first pattern prevents broken upgrades)

**No Action Required**: All improvements are automatic and require no configuration changes.

### For Deep Project Paths

If your project path is very deep (e.g., `/home/user/very/long/project/path/.../`), the daemon will automatically use a shorter socket path:

1. Try: `.claude/hooks-daemon/untracked/daemon-hostname.sock` (preferred)
2. Fallback: `$XDG_RUNTIME_DIR/claude-hooks-user/daemon-hostname.sock`
3. Fallback: `/tmp/claude-hooks-user/daemon-hostname.sock`

You'll see a log message indicating which path was used. No manual configuration needed.

### For Users with Python 3.10 or Older

**Action Required**: Upgrade to Python 3.11 or newer before installing/upgrading.

The installer will now detect your Python version and abort with a clear error message:

```
ERROR: Python 3.11+ is required (found: Python 3.10.12)
Please upgrade Python or specify a compatible interpreter with PYTHON environment variable.
```

**Options**:
1. Upgrade system Python to 3.11+
2. Install Python 3.11+ separately and use `PYTHON=/path/to/python3.11 ./install.py`

## Full Changelog

**Compare**: https://github.com/Edmonds-Commerce-Limited/claude-code-hooks-daemon/compare/v2.9.0...v2.10.0

### Commits in This Release

Plan 00046 implementation (6 phases):
- `e3217ab` Plan 00046: Phase 1 - Fix upgrade system root cause & nested installs
- `ae7ac25` Plan 00046: Phase 2 - Python version detection for 3.11+ requirement
- `98e6d5f` Plan 00046: Phase 3 - Socket path length validation with fallback
- `964ae31` Plan 00046: Phase 3 extra - Self-install path detection & server error handling
- `2d86d5e` Plan 00046: Phase 4 - Config validation UX improvements
- `38853c9` Plan 00046: Phase 5 - Update LLM-UPDATE.md documentation
- `687cbac` Plan 00046: Complete - Upgrade system overhaul

Related improvements:
- `6f32b84` Add: Installation feedback file instructions to LLM-INSTALL.md
- `e131232` Docs: Add async agent warning to release process (v2.9.0 incident)
- `5126237` Fix: Update path isolation tests for socket length fallback
- `e27ea42` Fix: QA issues in validation_ux - type annotations and magic values
- `86b636e` Style: Black auto-format server.py line length

### File Changes Summary

**Plan 00046 Changes**:
- **Phase 1**: upgrade.sh, venv.sh (checkout-first pattern, nested install detection)
- **Phase 2**: prerequisites.sh, upgrade.sh, venv.sh (Python version validation)
- **Phase 3**: daemon/paths.py, daemon/server.py (socket path validation and fallback)
- **Phase 3 Extra**: daemon/paths.py, daemon/server.py (self-install detection, OSError handling)
- **Phase 4**: config/validation_ux.py (fuzzy suggestions, friendly errors)
- **Phase 5**: LLM-UPDATE.md (comprehensive documentation updates)

**New Modules**:
- `config/validation_ux.py` - User-friendly Pydantic error formatting

**Updated Modules**:
- `daemon/paths.py` - Socket path length validation and fallback logic
- `daemon/server.py` - OSError catching with actionable messages
- `scripts/upgrade.sh` - Checkout-first pattern, nested install detection
- `scripts/venv.sh` - Python version validation
- `scripts/prerequisites.sh` - Python version validation

**New Tests**:
- `tests/unit/config/test_validation_ux.py` - Config validation UX tests
- `tests/integration/test_path_isolation_socket_length_fallback.py` - Socket fallback tests

## Next Steps

After installation or upgrade:

1. **Verify daemon starts successfully**: Run `python -m claude_code_hooks_daemon.daemon.cli status`
2. **Check socket path**: Review daemon logs to see which socket path tier was used
3. **Review config validation**: If you have config typos, you'll now get helpful suggestions
4. **Provide feedback**: Use the template in LLM-INSTALL.md to report any issues

## Known Issues

None at this time.

## Feedback

Report issues or request features at: https://github.com/Edmonds-Commerce-Limited/claude-code-hooks-daemon/issues

For installation feedback, see the template in LLM-INSTALL.md.
