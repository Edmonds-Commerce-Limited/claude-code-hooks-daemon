# Release v2.15.0 - Error Hiding Blocker, Shellcheck QA & Strategy Pattern Improvements

**Release Date:** 2026-02-19
**Type:** Minor Release

## Summary

This minor release adds a new safety handler that blocks error-hiding patterns before they reach disk, completes the PipeBlocker Strategy Pattern redesign, integrates shellcheck into the QA pipeline as a mandatory check, and adds several developer experience improvements to the release process and acceptance test infrastructure. All changes are backwards-compatible.

## Highlights

- **ErrorHidingBlockerHandler** - New PreToolUse:Write safety handler (priority 13) using Strategy Pattern with 5 language strategies to block silent error patterns before they are written to files
- **PipeBlockerHandler Strategy Pattern** (Plan 00064) - PipeBlocker redesigned to Strategy Pattern for extensibility; registry-based architecture matches the lint and TDD enforcement handlers
- **Shellcheck QA check #8** - All shell scripts now validated by `shellcheck -x` with zero tolerance for warnings; `.shellcheckrc` added for proper source-following
- **Color-coded git branch** - Status line branch name now green (default), orange (non-default), or grey (unknown)
- **Code review gate** in release process - New Step 7.5 blocking gate requiring code diff review before acceptance testing
- **Acceptance test scoping** - MAJOR/MINOR requires full suite; PATCH with handler changes requires targeted tests; PATCH with no handler changes may skip

## Changes

### Added

#### ErrorHidingBlockerHandler (Plan 00063 Phase 3)

**What it is:** A PreToolUse:Write handler at priority 13 that blocks files containing error-hiding patterns before they are written to disk. This prevents silent failure constructs from ever entering the codebase.

**Strategy Pattern architecture:**

Uses the same Strategy Pattern as `LintOnEditHandler` and `TddEnforcementHandler`:
- `ShellErrorHidingStrategy` - Detects `|| true`, `|| :`, `set +e`, `2>/dev/null` suppression
- `PythonErrorHidingStrategy` - Detects `except: pass`, `except Exception: pass`, bare `except` blocks
- `JavaScriptErrorHidingStrategy` - Detects empty catch blocks, swallowed promise rejections (covers `.js`, `.ts`, `.jsx`, `.tsx`, `.mjs`, `.cjs`)
- `GoErrorHidingStrategy` - Detects `_ = err`, ignored error returns
- `JavaErrorHidingStrategy` - Detects empty catch blocks, `catch (Exception e) {}`

**Why it matters:** Silent error patterns violate the FAIL FAST engineering principle. Errors hidden with `|| true` or `except: pass` mask real bugs. This handler enforces FAIL FAST at the point of authorship, before the code reaches tests or review.

#### PipeBlockerHandler Strategy Pattern Redesign (Plan 00064)

**What changed:** PipeBlocker refactored from a monolithic handler to a Strategy Pattern architecture matching the rest of the codebase.

**New structure:**
- `PipeBlockerHandler` - Thin orchestrator, delegates to strategy registry
- `ShellPipeBlockerStrategy` - Shell-specific dangerous pipe patterns
- `PythonPipeBlockerStrategy` - Python pipe/shell injection patterns
- `JavaScriptPipeBlockerStrategy` - JavaScript/TypeScript pipe patterns
- `GoPipeBlockerStrategy` - Go pipe patterns
- `JavaPipeBlockerStrategy` - Java pipe patterns
- `RubyPipeBlockerStrategy` - Ruby pipe patterns
- `RustPipeBlockerStrategy` - Rust pipe patterns
- `UniversalPipeBlockerStrategy` - Language-agnostic dangerous pipe patterns
- Strategy registry - Maps file extensions to strategies

**Why this matters:** The original PipeBlocker had language-specific logic directly in the handler, violating the Open/Closed Principle. The Strategy Pattern redesign shipped 8 language strategies and allows new languages to be added by implementing a new strategy without touching the handler.

#### Shellcheck QA Integration (Check #8)

**New mandatory QA check:** `./scripts/qa/run_shell_check.sh` runs `shellcheck -x` on all shell scripts in the repository.

**Zero tolerance:** Both errors and warnings must be zero. The QA pipeline (`run_all.sh`) now reports 8 checks instead of 7.

**`.shellcheckrc` configuration:**
```ini
source-path=SCRIPTDIR
```
Enables proper source-following so `shellcheck` correctly resolves relative `source` / `.` directives in scripts.

**Warnings fixed across all scripts:**
- SC2034: Assigned but unused variables - removed or renamed with `_` prefix
- SC2155: Declare and assign separately to avoid masking return values
- SC2120/SC2119: Functions taking optional arguments correctly annotated
- SC1091: Source file following enabled via `.shellcheckrc`

#### Color-Coded Git Branch in Status Line

The branch name displayed in the status line now uses colour coding:
- **Green** - Currently on the default branch (main, master, trunk, develop)
- **Orange** - Currently on a non-default branch (feature, fix, release branches)
- **Grey** - Branch name cannot be determined (detached HEAD, no git repo)

Provides immediate visual context without requiring a separate git command.

#### Code Review Gate in Release Process (Step 7.5)

**New blocking gate** added to RELEASING.md between the Breaking Changes Check (Step 6.5) and Acceptance Testing (Step 8).

**What it requires:**
```bash
LAST_TAG=$(git describe --tags --abbrev=0)
git log --oneline "${LAST_TAG}..HEAD"
git diff "${LAST_TAG}..HEAD" -- src/
```

**Review checklist:**
- No obvious bugs in handler `matches()` / `handle()` logic
- No security anti-patterns
- Correct handler priority ranges
- Tests exist alongside every handler change
- No magic strings or numbers
- SOLID principles followed
- No accidental debug code or leftover TODOs
- Shell scripts use shellcheck-compatible patterns

**Why it exists:** Opus reviews documentation only. Before acceptance testing, main Claude must verify the code itself is correct.

#### Acceptance Test Scoping by Bump Type

**MAJOR/MINOR releases:** Full acceptance test suite required (~89 executable tests).

**PATCH releases with handler changes:** Targeted tests for changed handlers only. Identify changed handlers via:
```bash
git diff "${LAST_TAG}..HEAD" --name-only -- src/claude_code_hooks_daemon/handlers/
```

**PATCH releases with no handler changes:** Acceptance testing may be skipped. Rationale must be documented in release notes: `"PATCH release — no handler changes, acceptance testing not required"`.

**Why this matters:** Full acceptance testing takes 20-30 minutes. For pure documentation or infrastructure patches with no handler changes, this investment is not justified.

#### AcceptanceTest Metadata Fields

**`recommended_model`** (`RecommendedModel` enum): Declares which model should execute the test.
- `RecommendedModel.OPUS` - Complex tests requiring reasoning
- `RecommendedModel.SONNET` - Standard handler tests
- `RecommendedModel.HAIKU` - Simple pass/fail checks

**`requires_main_thread`** (`bool`): Declares whether the test must run in the main Claude Code session (not delegated to a sub-agent). Required `True` for:
- Tests involving lifecycle events (SessionStart, SessionEnd)
- Tests relying on system-reminder visibility
- Tests using Write/Edit tools (PreToolUse:Write handlers)

### Fixed

#### Shellcheck Warnings Across All Shell Scripts

Resolved all shellcheck warnings across every script in the repository:

- `scripts/install/daemon_control.sh` - SC2155 fixes
- `scripts/install/hooks_deploy.sh` - SC2034, SC2155 fixes
- `scripts/install/test_helpers.sh` - SC2120/SC2119 fixes
- `scripts/qa/run_dependency_check.sh` - SC1091, SC2155 fixes
- `scripts/qa/run_lint.sh` - SC2034 fixes
- `scripts/qa/run_security_check.sh` - SC2034 fixes
- `scripts/qa/run_shell_check.sh` - New file, shellcheck-clean from creation
- `scripts/qa/run_strategy_pattern_check.sh` - SC2155 fixes
- `scripts/validate_worktrees.sh` - SC1091, SC2034 fixes
- `scripts/venv-include.bash` - SC1091 fixes
- `scripts/debug_hooks.sh` - SC2034 fixes
- `.claude/ccy/Dockerfile` - Not a shell script; GPG fix separate (see below)

All scripts now pass `shellcheck -x` with zero errors and zero warnings.

#### ESLint PATH in validate_eslint_on_write

**Problem:** `validate_eslint_on_write` subprocess calls failed to find `eslint` when it was installed locally (not globally) because `node_modules/.bin` was not in PATH.

**Fix:** Prepend `node_modules/.bin` to PATH in the subprocess environment:
```python
env = {**os.environ, "PATH": f"node_modules/.bin:{os.environ.get('PATH', '')}"}
```

This matches Node.js convention where locally-installed binaries take precedence over global ones.

#### PipeBlocker Acceptance Test Commands

**Problem:** PipeBlocker acceptance test definitions used `echo`-wrapped commands (e.g., `echo "npm test | tail -5"`) to test blocking behaviour. Since `echo` is in `UNIVERSAL_WHITELIST_PATTERNS`, the handler extracted `echo "npm test"` as the source segment and allowed it through unblocked — the test always passed regardless of whether the real command would be blocked.

**Fix:** Two safe no-op patterns are used, chosen based on what the test must verify:

- **Blacklisted commands** (`npm test`, `pytest`): `false && CMD | tail -N`
  - bash operator precedence: `|` binds tighter than `&&`, so parsed as `false && (CMD | tail -N)`
  - `false` exits 1 → `&&` short-circuits → CMD never executes (safe even if hook fails)
  - `_extract_source_segment` splits on `&&` separator → source segment = `CMD`
  - Source matches blacklist → DENY with "expensive" message (blacklist path exercised) ✓

- **Unknown commands** (`find`): `[[ "CMD | tail -N" == 0 ]]`
  - Bash evaluates a false string comparison (exit 1), no side effects
  - The literal `| tail` inside the quoted string is found by the handler's regex
  - Source segment = `[[ "find ...` → not in blacklist → "unknown" path → `extra_whitelist` hint ✓

Direct commands (e.g. `npm test | tail -5`) are never used — they would execute if the hook ever failed to fire. `echo`-wrapped commands are never used — `echo` is in `UNIVERSAL_WHITELIST_PATTERNS`.

#### health-check.sh Wrong Command Name

**Problem:** `health-check.sh` called `config-validate` which does not exist. The correct CLI command is `validate-config`.

**Fix:** Updated health-check.sh to call the correct `validate-config` command.

#### Dockerfile GPG Key Dearmoring for Dart SDK

**Problem:** The CCY Dockerfile added the Dart SDK apt repository GPG key without dearmoring it, causing `apt-get update` to fail on some Ubuntu/Debian base images that require the ASCII-armored key to be converted to binary format.

**Fix:** Added `gpg --dearmor` step before writing the key to `/usr/share/keyrings/`:
```dockerfile
RUN curl -fsSL https://dl-ssl.google.com/linux/linux_signing_key.pub \
    | gpg --dearmor -o /usr/share/keyrings/dart.gpg
```

## Installation

### New Installations

```bash
cd .claude
git clone -b v2.15.0 https://github.com/Edmonds-Commerce-Limited/claude-code-hooks-daemon.git hooks-daemon
cd hooks-daemon
python3 -m venv untracked/venv
untracked/venv/bin/pip install -e .
untracked/venv/bin/python install.py
```

### Upgrading Existing Installations

**Option 1: Using the /hooks-daemon skill (recommended):**

```bash
/hooks-daemon upgrade
```

**Option 2: Manual upgrade:**

```bash
cd .claude/hooks-daemon
git fetch --tags
git checkout v2.15.0
untracked/venv/bin/pip install -e .
untracked/venv/bin/python -m claude_code_hooks_daemon.daemon.cli restart
```

**Option 3: Scripted upgrade:**

```bash
cd .claude/hooks-daemon
./scripts/upgrade_version.sh v2.15.0
```

## Testing

- **Tests:** 6255 passing, 0 failed, 4 skipped (95.1% coverage — exceeds 95% requirement)
- **Type Safety:** MyPy strict mode compliant (0 errors)
- **Security:** Bandit scan clean (0 issues)
- **Linting:** Ruff clean (0 violations)
- **Formatting:** Black compliant (0 files need reformatting)
- **Magic Values:** 0 violations
- **Dependencies:** 0 issues
- **Shell Scripts:** Shellcheck clean (0 errors, 0 warnings) — new in v2.15.0

## Contributors

This release includes commits from:
- Edmonds Commerce team
- Claude Sonnet 4.6 (AI-assisted development)

## Breaking Changes

No breaking changes. This release is fully backwards-compatible with v2.14.0.

All new features are additive:
- `ErrorHidingBlockerHandler` is a new handler; existing configs are unaffected until the handler is enabled
- `PipeBlockerHandler` Strategy Pattern redesign preserves all existing blocking behaviour; no config changes required
- Shellcheck QA check is additive to the pipeline; existing scripts were fixed in the same release
- `recommended_model` and `requires_main_thread` fields on `AcceptanceTest` have safe defaults

## Full Changelog

**Compare:** https://github.com/Edmonds-Commerce-Limited/claude-code-hooks-daemon/compare/v2.14.0...v2.15.0

**13 commits since v2.14.0:**
- `921f146` Fix: properly dearmor GPG key for Dart SDK apt repository
- `692bf0b` Add: ErrorHidingBlockerHandler - language-aware error-hiding detection
- `6f7809d` Fix: shellcheck QA check 8 - resolve all warnings
- `d6c698f` Plan 00064: Complete - PipeBlocker Strategy Pattern Redesign
- `921f15f` Add: PipeBlockerHandler Strategy Pattern redesign (Plan 00064)
- `8a1d0e7` Fix: prepend node_modules/.bin to PATH in validate_eslint_on_write subprocess call
- `45bd733` Add: recommended_model + requires_main_thread to AcceptanceTest
- `d50c976` Add: RecommendedModel enum + recommended_model/requires_main_thread fields to AcceptanceTest
- `b098cd1` Add: color-coded git branch in status line (green=default, orange=other, grey=unknown)
- `26ff3b6` Fix: track ccy/Dockerfile by removing blanket ccy/ ignore rule
- `cca6f69` Add: code review gate + patch/minor/major acceptance test scoping to release
- `8d25361` Add: shellcheck to QA pipeline (check 8)
- `072b2ea` Fix: health-check.sh uses wrong config-validate command name

See [CHANGELOG.md](../CHANGELOG.md#2150---2026-02-19) for the categorised changelog entry.
