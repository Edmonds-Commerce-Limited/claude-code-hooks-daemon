# Release v2.5.0 - Plugin System Enhancement and Multi-Environment Support

**Release Date:** 2026-02-09
**Type:** Minor Release

## Summary

Version 2.5.0 brings significant enhancements to the plugin system, multi-environment daemon isolation, and comprehensive testing infrastructure. This release adds 9 new handlers for system package safety and workflow automation, complete plugin system overhaul with acceptance testing, and introduces hostname-based isolation for running daemons across multiple environments simultaneously.

## Highlights

- **Complete Plugin System Overhaul**: Event-type aware plugin loading with comprehensive acceptance testing (Plan 00024)
- **9 New Safety and Workflow Handlers**: Lock file protection, system package safety, TDD advisor, orchestrator mode
- **Hostname-Based Daemon Isolation**: Run daemons in multiple environments without conflicts
- **Programmatic Acceptance Testing**: Ephemeral playbook generation for all 59+ handlers (Plan 00025)
- **Worktree Support**: CLI flags for git worktree isolation with parallel development (Plan 00028)
- **Config Validation at Startup**: Fail-fast validation before daemon starts (Plan 00020)
- **Dependency Checking**: Integrated deptry into QA suite for dependency validation

## Changes

### Added
- **Lock File Edit Blocker Handler**: Prevents editing package lock files (package-lock.json, yarn.lock, composer.lock, etc.) - Plan 00031
- **5 System Package Safety Handlers**: Block dangerous package management operations (Plan 00022)
  - `pip_break_system` - Blocks pip --break-system-packages flag
  - `sudo_pip` - Blocks sudo pip install commands
  - `curl_pipe_shell` - Blocks curl/wget piped to shell
  - `dangerous_permissions` - Blocks chmod 777 and similar unsafe permissions
  - `global_npm_advisor` - Advises against npm install -g
- **Orchestrator-Only Mode Handler**: Opt-in mode for handlers that only run in orchestrator context (Plan 00019)
- **Plan Completion Move Advisor**: Guides moving completed plans to archive folder (Plan 00027)
- **TDD Advisor Handler**: Enforces test-driven development workflow with task-based guidance
- **Hostname-Based Daemon Isolation**: Multi-environment support with hostname-suffixed runtime files (sockets, PIDs, logs)
- **Worktree CLI Flags**: Added --pid-file and --socket flags for git worktree isolation (Plan 00028)
- **Programmatic Acceptance Testing System**: Ephemeral playbook generation from handler metadata (Plan 00025)
- **Plugin Support in Playbook Generator**: Acceptance tests now include plugin handlers (Plan 00040)
- **Config Validation at Daemon Startup**: Validates configuration before daemon starts (Plan 00020)
- **Comprehensive Handler Integration Tests**: Added integration tests for all handlers (Plan 00016)
- **Deptry Dependency Checking**: Integrated deptry into QA suite for dependency validation
- **LanguageConfig Foundation**: Centralized language-specific configuration for QA suppression handlers (Plan 00021)
- **Agent Team Workflow Documentation**: Multi-role verification structure with honesty checker (Plan 00030)
- **Worktree Automation Scripts**: Parallel plan execution with git worktree support
- **Code Lifecycle Documentation**: Complete Definition of Done checklists for features, bugs, and general changes

### Changed
- **Plugin System Architecture**: Complete overhaul with event_type field and daemon integration (Plan 00024)
- **QA Suppression Handlers**: Refactored to use centralized LanguageConfig data layer (Plan 00021)
- **Strict Mode Behavior**: Unified daemon.strict_mode for all fail-fast behavior across handlers
- **Acceptance Testing**: Migrated all 59+ handlers to programmatic acceptance tests with empty array rejection
- **Magic Value Elimination**: Removed all magic strings and numbers, replaced with constants (Plan 00012)
- **Plan Workflow**: Enhanced planning system with completion checklists and archive automation
- **Status Line Display**: Added effort level display and thinking toggle logic for Opus 4.6 extended thinking
- **Markdown Handler**: Allow writes outside project root for cross-project documentation (Plan 00029)
- **LLM Upgrade Experience**: Improved upgrade documentation and verification (Plan 00023)
- **Plugin Loader**: Handle Handler suffix correctly in class name detection
- **Duplicate Handler Priorities**: Made deterministic with warning logs for conflicts

### Fixed
- **HOTFIX: Decision Import**: Fixed wrong import path in 5 new handlers (constants.decision vs core.Decision)
- **Sed Blocker False Positive**: Fixed blocking of legitimate gh CLI commands
- **Plugin Schema Validation**: Fixed plugins config integration test validation
- **PreCompact Hook Schema**: Fixed systemMessage format validation
- **Daemon Path Isolation**: Fixed worktree isolation with proper path handling (Plan 00028)
- **Handler Instantiation Test**: Fixed test suite for dynamic handler loading
- **Markdown Plan Number Validation**: Corrected plan number detection in markdown files
- **Type Hints**: Fixed MyPy violations in 5 system package safety handlers
- **Magic Value Violations**: Eliminated remaining magic values in test_models.py and paths.py
- **Import Errors**: Removed non-existent qa_suppression_base import references
- **Plan Status Accuracy**: Corrected multiple plan completion statuses after audit
- **Test Failures**: Resolved hostname isolation test failures and fixture updates

### Security
- Maintained ZERO security violations across entire codebase
- All new handlers follow security best practices (no shell=True, proper subprocess usage)

### Documentation
- Added comprehensive Code Lifecycle guides (Features.md, Bugs.md, General.md)
- Enhanced PlanWorkflow.md with completion checklist and atomic commit guidance
- Added Agent Team workflow with multi-role verification
- Updated handler development guide with acceptance testing requirements
- Documented worktree workflow and parallel plan execution

## Upgrade Instructions

This release is backwards compatible. No breaking changes or special upgrade steps required.

**Configuration Changes**: None required, but new handlers are available for opt-in.

For version-specific upgrade guides, see `CLAUDE/UPGRADES/` directory.

## Installation

### New Installations

```bash
cd .claude
git clone -b v2.5.0 https://github.com/Edmonds-Commerce-Limited/claude-code-hooks-daemon.git hooks-daemon
cd hooks-daemon
python3 -m venv untracked/venv
untracked/venv/bin/pip install -e .
untracked/venv/bin/python install.py
```

### Upgrading Existing Installations

```bash
cd .claude/hooks-daemon
git fetch --tags
git checkout v2.5.0
untracked/venv/bin/pip install -e .
untracked/venv/bin/python -m claude_code_hooks_daemon.daemon.cli restart
```

## Technical Details

### Plugin System Overhaul (Plan 00024)

Complete architectural redesign of the plugin system:

**Key Changes**:
- Added `event_type` field to PluginConfig model for explicit event routing
- Integrated plugin loading into DaemonController for proper lifecycle management
- Fixed plugin handler loading to respect Handler suffix naming convention
- Added comprehensive daemon integration tests for plugin loading
- Enhanced error messages for plugin loading failures
- Made duplicate priorities deterministic with warning logs

**Before**: Plugins loaded at import time, no event type awareness
**After**: Plugins loaded by daemon, event-type aware, with full integration tests

**Benefits**:
- Plugins can now specify which event types they handle
- Daemon properly manages plugin lifecycle
- Better error reporting for plugin failures
- Acceptance testing includes plugin handlers

### Hostname-Based Daemon Isolation

Multi-environment support without conflicts:

**How It Works**:
- Uses `HOSTNAME` environment variable as runtime file suffix
- Each hostname gets isolated socket, PID, and log files
- Sanitized for filesystem safety (lowercase, spaces to hyphens)
- Falls back to time-based MD5 hash if hostname unavailable

**Path Pattern**:
- With hostname: `.claude/hooks-daemon/untracked/daemon-{hostname}.{sock,pid,log}`
- No hostname: `.claude/hooks-daemon/untracked/daemon-{hash}.{sock,pid,log}`

**Use Cases**:
- Running daemon in multiple containers simultaneously
- Separate daemon instances on different machines with shared filesystem
- Development and testing environments on same machine

### Programmatic Acceptance Testing System (Plan 00025)

Ephemeral playbook generation from handler metadata:

**Key Features**:
- Every handler defines acceptance tests via `get_acceptance_tests()` method
- Empty test arrays rejected (handlers MUST have acceptance tests)
- Playbook generated on-demand, not committed to git
- All 59+ handlers migrated to programmatic tests
- Plugin handlers automatically included in playbook

**Benefits**:
- Acceptance tests live with handler code (single source of truth)
- No manual playbook maintenance
- Guaranteed test coverage for all handlers
- Plugin handlers automatically tested

**Playbook Generation**:
```bash
# Generate playbook from all handler metadata
python -m claude_code_hooks_daemon.testing.generate_playbook
```

### Worktree Support (Plan 00028)

Git worktree isolation for parallel development:

**New CLI Flags**:
- `--pid-file PATH`: Override PID file location
- `--socket PATH`: Override socket file location

**Use Case**:
```bash
# Create worktree for parallel plan execution
git worktree add ../worktree-plan-042 main

# Start isolated daemon in worktree
cd ../worktree-plan-042
python -m claude_code_hooks_daemon.daemon.cli start \
  --pid-file ./untracked/daemon-worktree.pid \
  --socket ./untracked/daemon-worktree.sock
```

**Automation**:
- Scripts in `scripts/worktree/` for automated worktree management
- Documentation in `CLAUDE/Worktree.md`
- Parallel plan execution without daemon conflicts

### Config Validation at Startup (Plan 00020)

Fail-fast validation before daemon starts:

**Validation Checks**:
- JSON schema validation for configuration structure
- Handler registration validation (all handlers exist)
- Plugin path validation (all paths exist and are readable)
- Priority range validation (handlers in allowed ranges)
- Event type validation (all event types supported)

**Strict Mode**:
```yaml
daemon:
  input_validation:
    strict_mode: true  # Fail-closed on validation errors
```

**Benefits**:
- Catch configuration errors before daemon accepts connections
- Clear error messages for invalid configuration
- Prevents silent failures from misconfiguration

### New Handlers

#### Lock File Edit Blocker (Plan 00031)

Prevents accidental editing of package lock files:

**Blocked Files**:
- `package-lock.json` (npm)
- `yarn.lock` (Yarn)
- `pnpm-lock.yaml` (pnpm)
- `composer.lock` (PHP Composer)
- `Gemfile.lock` (Ruby Bundler)
- `Pipfile.lock` (Python Pipenv)
- `poetry.lock` (Python Poetry)

**Why**: Lock files should only be modified by package managers, not manually edited.

#### System Package Safety Handlers (Plan 00022)

5 new handlers to prevent dangerous package management operations:

**1. PipBreakSystemHandler**:
- Blocks `pip install --break-system-packages`
- Encourages virtual environments

**2. SudoPipHandler**:
- Blocks `sudo pip install`
- Prevents system-wide package pollution

**3. CurlPipeShellHandler**:
- Blocks `curl URL | bash` and `wget URL | sh`
- Prevents executing untrusted remote code

**4. DangerousPermissionsHandler**:
- Blocks `chmod 777`, `chmod -R 777`
- Encourages proper permission management

**5. GlobalNpmAdvisorHandler** (Advisory):
- Warns on `npm install -g`
- Suggests local installation alternatives

#### TDD Advisor Handler

Task-based TDD workflow enforcement:

**Features**:
- Detects code changes without corresponding tests
- Provides guidance on TDD red-green-refactor cycle
- Integrates with task management systems
- Advisory mode (warns, doesn't block)

#### Orchestrator-Only Mode Handler (Plan 00019)

Opt-in mode for handlers that only run in orchestrator context:

**Configuration**:
```yaml
handlers:
  pre_tool_use:
    my_handler:
      enabled: true
      orchestrator_only: true  # Only run in orchestrator
```

**Use Cases**:
- Handlers that require user interaction
- Handlers that spawn subagents
- Handlers that manage workflow state

### LanguageConfig Foundation (Plan 00021)

Centralized language-specific configuration:

**Architecture**:
- Single source of truth for language patterns
- Shared by all QA suppression handlers
- Extensible for new languages

**Languages Supported**:
- Python (type: ignore, noqa, pylint: disable)
- TypeScript/JavaScript (eslint-disable, @ts-ignore)
- PHP (@phpstan-ignore, phpcs:ignore)
- Go (//nolint, //lint:ignore)

**Benefits**:
- DRY principle for QA suppression patterns
- Easy to add new languages
- Consistent behavior across handlers

## Testing

- **Tests**: 4261 passing (1089 new tests since v2.4.0)
- **Coverage**: 95%+ maintained
- **Type Safety**: MyPy strict mode compliant
- **Security**: ZERO violations (Bandit scan clean)
- **Dependencies**: Deptry validation passing

All QA checks automated via `./scripts/qa/run_all.sh`:
- Magic Values Check (new)
- Black (formatting)
- Ruff (linting)
- MyPy (type checking)
- Pytest (tests + coverage)
- Bandit (security scanning)
- Deptry (dependency validation - new)

## Contributors

This release includes contributions from:
- joseph
- Claude Code AI assistant (Sonnet 4.5)

## Development Workflow Improvements

This release demonstrates enhanced development practices:

1. **Plugin System Maturity**: Full lifecycle management with acceptance testing
2. **Multi-Environment Support**: Isolated daemons for parallel development
3. **Comprehensive Testing**: Programmatic acceptance tests for all handlers
4. **Code Lifecycle Documentation**: Complete Definition of Done checklists
5. **Agent Team Workflow**: Multi-role verification with honesty checking
6. **Worktree Automation**: Parallel plan execution without conflicts

## Known Issues

None. All features fully tested and documented.

## Future Roadmap

Planned for upcoming releases:
- Handler dependency system for explicit ordering
- Performance monitoring and metrics dashboard
- Advanced plugin system features (hot reload, versioning)
- Additional workflow automation handlers
- Enhanced status line with more context

## Migration Notes

### For Plugin Developers

If you have custom plugins, no changes required. However, you can now specify `event_type` in plugin configuration for explicit event routing:

```yaml
plugins:
  plugins:
    - path: "./my_handlers"
      event_type: "PreToolUse"  # Optional: explicit event type
      enabled: true
```

### For Handler Developers

All handlers should now implement `get_acceptance_tests()`:

```python
@staticmethod
def get_acceptance_tests() -> list[AcceptanceTest]:
    return [
        AcceptanceTest(
            name="Test handler blocks pattern X",
            command="command to test",
            expected_decision="deny",
            expected_reason_contains="blocked because"
        )
    ]
```

## Full Changelog

**Compare**: https://github.com/Edmonds-Commerce-Limited/claude-code-hooks-daemon/compare/v2.4.0...v2.5.0

See `CHANGELOG.md` for detailed changes.

---

**Installation Support**: See `CLAUDE/LLM-INSTALL.md`
**Update Guide**: See `CLAUDE/LLM-UPDATE.md`
**Architecture**: See `CLAUDE/ARCHITECTURE.md`
**Contributing**: See `CONTRIBUTING.md`
