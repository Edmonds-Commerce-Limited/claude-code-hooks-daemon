# Release v2.7.0 - DRY Install/Upgrade Architecture and Config Preservation

**Release Date:** 2026-02-10
**Type:** Minor Release

## Summary

Version 2.7.0 delivers a complete architectural overhaul of the installation and upgrade system with a focus on config preservation, modularity, and maintainability. This release introduces a comprehensive config preservation engine with 82 tests, transforms the monolithic install/upgrade scripts into a modular Bash library with 14 reusable components, and establishes Layer 2 orchestrators that dramatically simplify the entry points. The release also includes critical fixes for upgrade script issues and enhances the handler registry architecture for better consistency.

## Highlights

- **Config Preservation Engine**: Complete 4-module system (differ, merger, validator, CLI) with 82 comprehensive tests ensures user customizations survive upgrades
- **Modular Bash Install Library**: 14 reusable modules in `scripts/install/` enable DRY architecture and testability
- **Layer 2 Orchestrators**: Simplified install/upgrade entry points (116 and 134 lines, down from 307 and 612)
- **Handler Registry Enhancement**: HandlerID constants as single source of truth eliminate config key inconsistencies (Plan 00039)
- **8 Critical Upgrade Fixes**: Heredoc, permissions, backups, validation, error handling, and more
- **Enhanced Status Line**: Emoticon-based context display with color-coded quarter circle icons

## Changes

### Added

- **Config Preservation Engine** (Plan 00041)
  - Complete system for preserving user config customizations during upgrades
  - Four core modules working together:
    - `config_differ.sh` - Detects changes between old and new default configs
    - `config_merger.sh` - Intelligently merges user customizations with new defaults
    - `config_validator.sh` - Validates merged config structure and integrity
    - `config_cli.sh` - User-facing commands for manual config operations
  - 82 comprehensive tests covering all edge cases and scenarios
  - Handles handler additions, removals, priority changes, and new config sections
  - Preserves comments and formatting where possible
  - Rollback support if merge fails validation

- **Modular Bash Install Library** (Plan 00041)
  - 14 reusable modules in `scripts/install/` directory
  - **Core Modules**:
    - `common.sh` - Shared utilities and constants
    - `logging.sh` - Consistent logging with colors and formatting
    - `validation.sh` - Pre/post-install validation checks
    - `backup.sh` - Config backup and restoration
  - **Config Modules**:
    - `config_differ.sh` - Config change detection
    - `config_merger.sh` - Intelligent config merging
    - `config_validator.sh` - Config structure validation
    - `config_cli.sh` - User-facing config commands
  - **Install Modules**:
    - `git_operations.sh` - Git clone, fetch, checkout operations
    - `venv_setup.sh` - Virtual environment creation and activation
    - `python_setup.sh` - Python package installation
    - `hook_scripts.sh` - Hook script deployment
  - **Upgrade Modules**:
    - `upgrade_checks.sh` - Pre-upgrade validation
    - `rollback.sh` - Upgrade rollback on failure
  - All modules follow DRY principles and are independently testable

- **Layer 2 Orchestrators** (Plan 00041)
  - `scripts/install_version.sh` - Install orchestrator (116 lines)
    - Down from 307 lines in original install.sh
    - Delegates all logic to modular library
    - Clear entry point with minimal logic
  - `scripts/upgrade_version.sh` - Upgrade orchestrator (134 lines)
    - Down from 612 lines in original upgrade.sh
    - Delegates all logic to modular library
    - Simplified error handling and rollback

- **VersionCheckHandler**
  - New SessionStart handler that displays current daemon version
  - Helps users verify which version is running
  - Useful for debugging and support

- **Example Config File**
  - `.claude/hooks-daemon.yaml.example` with comprehensive documentation
  - Documents all available handlers with descriptions
  - Serves as reference for configuration options
  - Kept in sync with library handlers via automated tests

- **Dynamic Example Config Validation**
  - Automated test ensures all library handlers are documented in example config
  - Prevents example config from going stale as handlers are added
  - Validates config structure and handler IDs

### Changed

- **Handler Registry Architecture** (Plan 00039)
  - Complete refactor to use HandlerID constants as single source of truth
  - All handlers now use `HandlerID.HANDLER_NAME` for self-identification
  - Config keys automatically derived from handler IDs
  - Eliminates manual config key strings and typos
  - Benefits:
    - No config key inconsistencies between code and config
    - Refactoring handlers automatically updates config keys
    - Type-safe handler identification
    - Single source of truth for handler names
  - Example:
    ```python
    # Before: Manual string (prone to typos)
    super().__init__(name="destructive-git-blocker", ...)

    # After: Constant (type-safe, refactor-safe)
    super().__init__(name=HandlerID.DESTRUCTIVE_GIT_BLOCKER, ...)
    ```

- **Status Line Enhancement**
  - Emoticon-based context display with visual feedback
  - Color-coded quarter circle icons matching percentage scheme:
    - Green circles for low usage (0-25%)
    - Yellow circles for moderate usage (25-50%)
    - Orange circles for high usage (50-75%)
    - Red circles for very high usage (75-100%)
  - More intuitive at-a-glance context consumption awareness

- **Install Architecture** (Plan 00041)
  - Complete separation of concerns: Layer 1 (library) + Layer 2 (orchestrators)
  - `install.sh` now a thin wrapper (116 lines) that delegates to `install_version.sh`
  - `upgrade.sh` now a thin wrapper (134 lines) that delegates to `upgrade_version.sh`
  - All business logic moved to testable modules
  - Benefits:
    - Easy to maintain and extend
    - Modules can be tested independently
    - Logic reused between install and upgrade
    - Clear separation of concerns

- **Release Workflow Documentation**
  - Added mandatory QA verification gate after Opus review
  - Added mandatory acceptance testing gate after QA
  - Documented FAIL-FAST cycle for test failures
  - Clarified that releases prioritize CORRECTNESS over SPEED
  - Updated all release process documentation

### Fixed

- **auto_continue_stop Handler** (Plan 00042)
  - Fixed detection of `stopHookActive` field (camelCase variant)
  - Handler now correctly detects both `stop_hook_active` and `stopHookActive`
  - Added comprehensive logging for field detection debugging
  - Prevents handler from failing when field name format changes

- **Upgrade Script Critical Fixes** (Plan 00041)
  - **8 critical fixes** addressing reliability and safety issues:

  1. **Heredoc Variable Expansion**
     - Fixed config heredoc to prevent shell variable expansion
     - Prevents corrupting config with unexpanded variables

  2. **Hook Script Permissions**
     - Hook scripts now properly marked executable after upgrade
     - Fixes "permission denied" errors when Claude Code invokes hooks

  3. **Timestamped Config Backups**
     - Backups now use timestamps to prevent overwriting previous backups
     - Enables multiple backup points for safer rollback

  4. **Version Skip Logic**
     - Upgrade now skips gracefully when already on target version
     - Prevents unnecessary reinstallation and config churn

  5. **Silent Error Handling**
     - Fixed upgrade script silently swallowing config validation errors
     - Errors now properly surface to user with clear messages

  6. **Python Version Detection**
     - Fixed Python version validation and error messaging
     - Better handling of Python version mismatches

  7. **Config Delegation**
     - Improved delegation to project agent for config fixes
     - Better error messages and guidance

  8. **Hook Script Redeployment**
     - Upgrade now ensures all hook scripts are redeployed
     - Fixes stale hook scripts after upgrade

## Upgrade Instructions

This release is backwards compatible. No breaking changes or special upgrade steps required.

**Recommended Upgrade Method**: Fetch and review the upgrade script, then run it:

```bash
# Download the upgrade script
curl -fsSL https://raw.githubusercontent.com/Edmonds-Commerce-Limited/claude-code-hooks-daemon/main/scripts/upgrade.sh -o /tmp/upgrade.sh

# Review it to ensure you're comfortable with what it does
less /tmp/upgrade.sh

# Run it
bash /tmp/upgrade.sh
```

Or use the slash command (if upgrading from v2.5.0+):

```
/hooks-daemon-update
```

**Configuration Changes**: None required. The config preservation engine automatically handles config migration during upgrade.

**Benefits of This Upgrade**:
- Much more reliable upgrade process with 8 critical fixes
- Your config customizations automatically preserved
- Simplified, modular architecture for future maintainability
- Better error handling and rollback support

For version-specific upgrade guides, see `CLAUDE/UPGRADES/` directory.

## Installation

### New Installations

```bash
cd .claude
git clone -b v2.7.0 https://github.com/Edmonds-Commerce-Limited/claude-code-hooks-daemon.git hooks-daemon
cd hooks-daemon
python3 -m venv untracked/venv
untracked/venv/bin/pip install -e .
untracked/venv/bin/python install.py
```

**AI-Assisted Installation (Recommended)**: See [LLM-INSTALL.md](https://raw.githubusercontent.com/Edmonds-Commerce-Limited/claude-code-hooks-daemon/main/CLAUDE/LLM-INSTALL.md)

### Upgrading Existing Installations

**Method 1: Fetch and Review Script (Recommended)**

```bash
# Download the upgrade script
curl -fsSL https://raw.githubusercontent.com/Edmonds-Commerce-Limited/claude-code-hooks-daemon/main/scripts/upgrade.sh -o /tmp/upgrade.sh

# Review it
less /tmp/upgrade.sh

# Run it
bash /tmp/upgrade.sh
```

**Method 2: Slash Command (v2.5.0+ only)**

```
/hooks-daemon-update
```

**Method 3: Local Script**

```bash
cd .claude/hooks-daemon
git fetch --tags
git checkout v2.7.0
untracked/venv/bin/pip install -e .
bash scripts/upgrade.sh
```

**AI-Assisted Upgrade**: See [LLM-UPDATE.md](https://raw.githubusercontent.com/Edmonds-Commerce-Limited/claude-code-hooks-daemon/main/CLAUDE/LLM-UPDATE.md)

## Technical Details

### Config Preservation Engine Architecture

The config preservation engine consists of four modules working together:

**1. config_differ.sh** - Change Detection
- Compares old config with new default config
- Identifies added/removed/changed handlers
- Detects priority changes and new config sections
- Output: Structured diff for merger consumption

**2. config_merger.sh** - Intelligent Merging
- Merges user customizations with new defaults
- Preserves enabled/disabled state for existing handlers
- Preserves custom priorities and settings
- Adds new handlers with defaults
- Removes deprecated handlers with warnings

**3. config_validator.sh** - Validation
- Validates YAML syntax
- Validates config structure (version, daemon, handlers sections)
- Validates handler references exist in code
- Validates priority ranges
- Ensures config will load successfully

**4. config_cli.sh** - User Interface
- `show-config-changes` - Display what changed between versions
- `validate-config` - Check config validity
- `backup-config` - Create timestamped backup
- `restore-config` - Restore from backup
- User-friendly commands for config operations

**Testing**: 82 comprehensive tests covering:
- Handler additions and removals
- Priority changes
- Custom settings preservation
- Validation edge cases
- Rollback scenarios
- Error handling

### Modular Install Architecture

**Layer 1: Modular Library** (`scripts/install/`)
- 14 focused modules, each with single responsibility
- Testable in isolation
- Reusable across install/upgrade/rollback
- Well-documented interfaces

**Layer 2: Orchestrators** (`scripts/`)
- `install_version.sh` - Coordinates install flow
- `upgrade_version.sh` - Coordinates upgrade flow
- Thin wrappers that delegate to Layer 1
- Clear, readable orchestration logic

**Layer 3: Entry Points** (root)
- `install.sh` - User-facing install entry (delegates to Layer 2)
- `upgrade.sh` - User-facing upgrade entry (delegates to Layer 2)
- Backwards compatible with existing docs

**Benefits**:
- **DRY**: No duplicated logic between install/upgrade
- **Testable**: Modules can be unit tested
- **Maintainable**: Changes isolated to specific modules
- **Extensible**: New features added as modules
- **Readable**: Clear separation of concerns

### Handler Registry Enhancement

Plan 00039 established HandlerID constants as the single source of truth:

**Before**:
```python
# Handler code
class DestructiveGitHandler(Handler):
    def __init__(self):
        super().__init__(name="destructive-git-blocker", ...)

# Config
handlers:
  pre_tool_use:
    destructive_git_blocker:  # Typo risk!
      enabled: true
```

**After**:
```python
# Constants
class HandlerID:
    DESTRUCTIVE_GIT_BLOCKER = "destructive-git-blocker"

# Handler code
class DestructiveGitHandler(Handler):
    def __init__(self):
        super().__init__(name=HandlerID.DESTRUCTIVE_GIT_BLOCKER, ...)

# Config (validated against constants)
handlers:
  pre_tool_use:
    destructive-git-blocker:  # Type-safe, refactor-safe
      enabled: true
```

**Impact**:
- All 60+ handlers migrated to use constants
- Config keys validated against handler IDs at startup
- Tests ensure consistency between code and config
- Refactoring handlers automatically updates config keys

## Testing

- **Tests:** 4578 passing (282 new tests since v2.6.1)
- **Coverage:** 100% (exceeds 95% requirement)
- **Type Safety:** MyPy strict mode compliant (0 errors)
- **Security:** Bandit scan clean (0 issues)
- **Linting:** Ruff clean (0 violations)
- **Formatting:** Black compliant

## Quality Assurance

All QA checks passing:

```
========================================
QA Summary
========================================
  Magic Values        : ✅ PASSED
  Format Check        : ✅ PASSED
  Linter              : ✅ PASSED
  Type Check          : ✅ PASSED
  Tests               : ✅ PASSED
  Security Check      : ✅ PASSED

Overall Status: ✅ ALL CHECKS PASSED
```

## Contributors

This release includes contributions from:
- Edmonds Commerce Limited
- Claude Sonnet 4.5 (AI-assisted development)

## Development Workflow Improvements

This release demonstrates continued commitment to engineering excellence:

1. **Config Preservation**: Ensures user customizations never lost during upgrades
2. **Modular Architecture**: DRY principles applied to Bash scripting
3. **Comprehensive Testing**: 82 new tests for config preservation alone
4. **Handler Consistency**: Single source of truth for handler IDs
5. **Critical Bug Fixes**: 8 upgrade script fixes improve reliability
6. **Enhanced Status Display**: Better visual feedback for context usage

## Breaking Changes

None. This release is fully backwards compatible with v2.6.1.

## Deprecations

- `install.py` - Deprecated in favor of `install.sh` (delegates to `install_version.sh`)
  - Still works but generates deprecation warning
  - Will be removed in v3.0.0
  - Migration path: Use `bash install.sh` instead of `python install.py`

## Known Issues

None. All features fully tested and documented.

## Future Roadmap

Planned for upcoming releases:
- Config migration testing framework
- Install/upgrade rollback improvements
- Plugin system enhancements
- Performance monitoring dashboard
- Additional workflow automation handlers

## Migration Notes

### For Upgraders

**No manual migration required**. The config preservation engine automatically:
- Detects your customizations
- Merges them with new defaults
- Validates the merged config
- Rolls back on any errors

**Recommended**: Review the upgrade script before running (Method 1 above).

### For Handler Developers

If you develop custom handlers, consider adopting the HandlerID pattern:

```python
# Define constants
class MyHandlerIDs:
    MY_CUSTOM_HANDLER = "my-custom-handler"

# Use in handler
class MyCustomHandler(Handler):
    def __init__(self):
        super().__init__(name=MyHandlerIDs.MY_CUSTOM_HANDLER, ...)
```

This ensures consistency and type safety.

## Full Changelog

**Compare:** https://github.com/Edmonds-Commerce-Limited/claude-code-hooks-daemon/compare/v2.6.1...v2.7.0

For complete details, see [CHANGELOG.md](../CHANGELOG.md#270---2026-02-10)

---

**Installation Support**: See `CLAUDE/LLM-INSTALL.md`
**Update Guide**: See `CLAUDE/LLM-UPDATE.md`
**Architecture**: See `CLAUDE/ARCHITECTURE.md`
**Contributing**: See `CONTRIBUTING.md`
