# Release v2.17.2 - Plan Number Validation Bug Fixes

**Release Date:** 2026-02-27
**Type:** Patch Release

## Summary

v2.17.2 fixes three bugs in the `validate_plan_number` handler that caused false positive warnings and silent validation failures during normal plan lifecycle operations.

## Changes

### Fixed

- **Plan Number Validation TOCTOU Race Condition**: Fixed false positive where the handler incorrectly demanded the next sequential plan number when a preceding `mkdir` had already created the plan directory before the `Write` tool created `PLAN.md`. The handler now accepts `plan_number == highest` (directory already created by mkdir) in addition to `plan_number == highest + 1` (normal new-plan case).

- **Plan Number Handler False Positives on Archive Operations**: Fixed handler incorrectly triggering when archiving plans via `git mv` to `CLAUDE/Plan/Completed/` or any organisational subfolder. Changed regex from `.*?` to `[^&;]*` to prevent matching across `&&`/`;` command boundaries into unrelated `git mv` arguments. Handler now matches only direct children of the `Plan/` root and scans all non-numbered organisational subfolders when detecting the highest existing plan number.

- **Plan Number Handler Hardcoded 3-Digit Width**: Fixed handler silently ignoring plan numbers with more or fewer than 3 digits. The handler used `\d{3}` regex which only matched exactly 3-digit numbers (e.g. `001`), causing it to completely skip validation for 5-digit plans like `00072` used by this project. Changed all regex patterns to `\d+` to support any digit width. Removed hardcoded `:03d` zero-padding from error messages.

## Test Results

- **Tests**: 6465 passed, 0 failed, 4 skipped
- **Coverage**: 95.0%
- **QA**: 8/8 checks passed
- **Handler-specific tests**: 65 passed for validate_plan_number

## Upgrade Instructions

No breaking changes. Standard upgrade procedure applies.

PATCH release with handler changes â€” targeted acceptance testing for validate_plan_number handler.

```bash
cd .claude/hooks-daemon
git fetch --tags
git checkout v2.17.2
untracked/venv/bin/pip install -e .
```

Or using the upgrade skill:

```bash
/hooks-daemon upgrade v2.17.2
```

After upgrading, restart the daemon:

```bash
untracked/venv/bin/python -m claude_code_hooks_daemon.daemon.cli restart
```

## Comparison

Full diff: https://github.com/Edmonds-Commerce-Limited/claude-code-hooks-daemon/compare/v2.17.1...v2.17.2
